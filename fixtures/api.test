#!/bin/bash
# ============================================================================
# 义城上门教育 - API 接口测试用例集
# ============================================================================
#
# 版本: v1.0
# 测试环境: http://localhost:8000
#
# 使用说明:
#   1. 确保后端服务已启动: uv run uvicorn src.main:app --reload
#   2. 确保数据库已初始化
#   3. 执行测试: bash fixtures/api.test
#   4. 查看测试结果输出
#
# 测试覆盖:
#   - 小程序端接口: 25个
#   - 管理端接口: 32个
#   - 正常功能测试
#   - 异常测试(参数校验、权限测试)
#   - 复杂场景测试(业务流程)
#
# ============================================================================

# set -e  # 遇到错误时停止执行（注释掉以便收集所有测试结果）

# 配置
API_BASE="http://localhost:8000"
CONTENT_TYPE="Content-Type: application/json"

# 颜色输出
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 全局变量
ADMIN_TOKEN=""
USER_TOKEN=""
COMMUNITY_ID=""
TEACHER_ID=""
COURSE_ID=""
STUDENT_ID=""
ORDER_ID=""
MEMBER_CARD_ID=""

# 测试计数
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# ============================================================================
# 工具函数
# ============================================================================

print_header() {
    echo ""
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}============================================================${NC}"
}

print_test() {
    echo ""
    echo -e "${YELLOW}[TEST $TOTAL_TESTS] $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ PASS: $1${NC}"
    ((PASSED_TESTS++))
}

print_fail() {
    echo -e "${RED}✗ FAIL: $1${NC}"
    ((FAILED_TESTS++))
}

print_summary() {
    echo ""
    echo -e "${BLUE}============================================================${NC}"
    echo -e "${BLUE}  测试总结${NC}"
    echo -e "${BLUE}============================================================${NC}"
    echo -e "总计: $TOTAL_TESTS"
    echo -e "${GREEN}通过: $PASSED_TESTS${NC}"
    echo -e "${RED}失败: $FAILED_TESTS${NC}"
    echo ""

    if [ $FAILED_TESTS -eq 0 ]; then
        echo -e "${GREEN}所有测试通过!${NC}"
        exit 0
    else
        echo -e "${RED}部分测试失败!${NC}"
        exit 1
    fi
}

# 检查响应code字段
check_response() {
    local response="$1"
    local expected_code="${2:-0}"
    local test_name="$3"

    ((TOTAL_TESTS++))

    # 提取code字段
    local code=$(echo "$response" | grep -o '"code":[0-9]*' | head -1 | grep -o '[0-9]*')

    if [ "$code" = "$expected_code" ]; then
        print_success "$test_name"
        return 0
    else
        print_fail "$test_name (expected code=$expected_code, got code=$code)"
        echo "Response: $response"
        return 1
    fi
}

# ============================================================================
# 基础测试 - 健康检查
# ============================================================================

print_header "基础测试"

print_test "健康检查接口"
response=$(curl -s "$API_BASE/health")
check_response "$response" 0 "健康检查接口"

# ============================================================================
# 管理端测试 - 认证模块
# ============================================================================

print_header "管理端 - 认证模块"

# 1. 管理员登录 - 正常
print_test "管理员登录 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/auth/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "username": "admin",
        "password": "admin123"
    }')
check_response "$response" 0 "管理员登录成功"
ADMIN_TOKEN=$(echo "$response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
echo "Admin Token: ${ADMIN_TOKEN:0:20}..."

# 2. 管理员登录 - 错误密码
print_test "管理员登录 - 错误密码"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/auth/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "username": "admin",
        "password": "wrongpassword"
    }')
check_response "$response" 10001 "错误密码应该返回错误码"

# 3. 管理员登录 - 缺少参数
print_test "管理员登录 - 缺少参数"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/auth/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "username": "admin"
    }')
check_response "$response" 10002 "缺少密码参数应该返回错误码"

# 4. 获取管理员信息 - 正常
print_test "获取管理员信息 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/auth/info" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取管理员信息成功"

# 5. 获取管理员信息 - 无Token
print_test "获取管理员信息 - 无Token"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/auth/info" \
    -H "$CONTENT_TYPE")
check_response "$response" 10003 "无Token应该返回401"

# 6. 获取管理员信息 - 无效Token
print_test "获取管理员信息 - 无效Token"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/auth/info" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer invalid_token_12345")
check_response "$response" 10003 "无效Token应该返回401"

# ============================================================================
# 管理端测试 - 小区模块
# ============================================================================

print_header "管理端 - 小区模块"

# 7. 创建小区 - 正常
print_test "创建小区 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/communities" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区A",
        "address": "海口市美兰区测试路123号",
        "image": "https://example.com/community.jpg",
        "latitude": 20.044220,
        "longitude": 110.199103
    }')
check_response "$response" 0 "创建小区成功"
COMMUNITY_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Community ID: $COMMUNITY_ID"

# 8. 创建小区 - 缺少必填字段
print_test "创建小区 - 缺少必填字段"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/communities" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区B"
    }')
check_response "$response" 10002 "缺少必填字段应该返回错误"

# 9. 创建小区 - 经纬度超出范围
print_test "创建小区 - 经纬度超出范围"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/communities" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区C",
        "address": "测试地址",
        "latitude": 200.0,
        "longitude": 300.0
    }')
check_response "$response" 10002 "经纬度超出范围应该返回错误"

# 10. 获取小区列表 - 正常
print_test "获取小区列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/communities?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取小区列表成功"

# 11. 获取小区列表 - 带搜索
print_test "获取小区列表 - 带搜索"
response=$(curl -s -G "$API_BASE/api/v1/admin/communities" \
    --data-urlencode "page=1" \
    --data-urlencode "page_size=10" \
    --data-urlencode "keyword=测试" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "搜索小区成功"

# 12. 更新小区 - 正常
print_test "更新小区 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/communities/$COMMUNITY_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区A(已更新)",
        "address": "海口市美兰区测试路456号",
        "latitude": 20.044220,
        "longitude": 110.199103
    }')
check_response "$response" 0 "更新小区成功"

# 13. 更新小区 - 不存在的ID
print_test "更新小区 - 不存在的ID"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/communities/nonexistent_id_12345" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区",
        "address": "测试地址",
        "latitude": 20.0,
        "longitude": 110.0
    }')
check_response "$response" 10004 "不存在的ID应该返回404"

# ============================================================================
# 管理端测试 - 教练模块
# ============================================================================

print_header "管理端 - 教练模块"

# 14. 创建教练 - 正常
print_test "创建教练 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/teachers" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "小黑老师",
        "avatar": "https://example.com/teacher.jpg",
        "bio": "国家一级体能教练",
        "specialties": ["体能训练", "跳绳", "篮球"],
        "status": 1
    }')
check_response "$response" 0 "创建教练成功"
TEACHER_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Teacher ID: $TEACHER_ID"

# 15. 创建教练 - 缺少必填字段
print_test "创建教练 - 缺少必填字段"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/teachers" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "bio": "测试简介"
    }')
check_response "$response" 10002 "缺少教练姓名应该返回错误"

# 16. 获取教练列表 - 正常
print_test "获取教练列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/teachers?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取教练列表成功"

# 17. 更新教练 - 正常
print_test "更新教练 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/teachers/$TEACHER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "小黑老师(高级)",
        "avatar": "https://example.com/teacher2.jpg",
        "bio": "国家一级体能教练、跳绳专家",
        "specialties": ["体能训练", "跳绳", "篮球", "足球"],
        "status": 1
    }')
check_response "$response" 0 "更新教练成功"

# 18. 删除教练 - 正常(先创建一个临时教练)
print_test "删除教练 - 正常"
temp_response=$(curl -s -X POST "$API_BASE/api/v1/admin/teachers" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "临时教练",
        "status": 1
    }')
temp_teacher_id=$(echo "$temp_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

response=$(curl -s -X DELETE "$API_BASE/api/v1/admin/teachers/$temp_teacher_id" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "删除教练成功"

# ============================================================================
# 管理端测试 - 课程模块
# ============================================================================

print_header "管理端 - 课程模块"

# 19. 创建课程 - 正常
print_test "创建课程 - 正常"
# 获取当前时间后7天作为报名截止时间
deadline_date=$(date -u -d "+7 days" +"%Y-%m-%dT%H:%M:%S" 2>/dev/null || date -u -v+7d +"%Y-%m-%dT%H:%M:%S")
start_date=$(date -u -d "+10 days" +"%Y-%m-%dT%H:%M:%S" 2>/dev/null || date -u -v+10d +"%Y-%m-%dT%H:%M:%S")
end_date=$(date -u -d "+80 days" +"%Y-%m-%dT%H:%M:%S" 2>/dev/null || date -u -v+80d +"%Y-%m-%dT%H:%M:%S")

response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"体能+跳绳\",
        \"age_range\": \"7-12岁\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"image\": \"https://example.com/course.jpg\",
        \"total_weeks\": 10,
        \"total_lessons\": 10,
        \"schedule\": \"周六 08:00-09:00\",
        \"location\": \"小区中心广场\",
        \"price\": 80.0,
        \"member_price\": 39.8,
        \"min_students\": 4,
        \"max_students\": 10,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"description\": \"专业体能训练+跳绳技巧教学\",
        \"status\": \"enrolling\"
    }")
check_response "$response" 0 "创建课程成功"
COURSE_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Course ID: $COURSE_ID"

# 20. 创建课程 - 价格为负数
print_test "创建课程 - 价格为负数"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"测试课程\",
        \"age_range\": \"7-12岁\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"total_weeks\": 10,
        \"total_lessons\": 10,
        \"schedule\": \"周六 08:00-09:00\",
        \"price\": -50.0,
        \"member_price\": 30.0,
        \"min_students\": 4,
        \"max_students\": 10,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"status\": \"enrolling\"
    }")
check_response "$response" 10002 "价格为负数应该返回错误"

# 21. 创建课程 - 最大人数小于最小人数
print_test "创建课程 - 最大人数小于最小人数"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"测试课程\",
        \"age_range\": \"7-12岁\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"total_weeks\": 10,
        \"total_lessons\": 10,
        \"schedule\": \"周六 08:00-09:00\",
        \"price\": 80.0,
        \"member_price\": 40.0,
        \"min_students\": 10,
        \"max_students\": 5,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"status\": \"enrolling\"
    }")
check_response "$response" 10002 "最大人数小于最小人数应该返回错误"

# 22. 获取课程列表 - 正常
print_test "获取课程列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/courses?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取课程列表成功"

# 23. 获取课程列表 - 按状态筛选
print_test "获取课程列表 - 按状态筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/courses?page=1&page_size=10&status=enrolling" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "按状态筛选课程成功"

# 24. 更新课程 - 正常
print_test "更新课程 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/courses/$COURSE_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"体能+跳绳(升级版)\",
        \"age_range\": \"7-12岁\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"total_weeks\": 10,
        \"total_lessons\": 10,
        \"schedule\": \"周六 08:00-09:00\",
        \"location\": \"小区中心广场\",
        \"price\": 90.0,
        \"member_price\": 45.0,
        \"min_students\": 4,
        \"max_students\": 10,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"description\": \"专业体能训练+跳绳技巧教学(升级版)\",
        \"status\": \"enrolling\"
    }")
check_response "$response" 0 "更新课程成功"

# 25. 更新课程状态 - 正常
print_test "更新课程状态 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/courses/$COURSE_ID/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "status": "ongoing"
    }')
check_response "$response" 0 "更新课程状态成功"

# 26. 更新课程状态 - 无效状态
print_test "更新课程状态 - 无效状态"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/courses/$COURSE_ID/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "status": "invalid_status"
    }')
check_response "$response" 10002 "无效状态应该返回错误"

# 恢复课程状态
curl -s -X PUT "$API_BASE/api/v1/admin/courses/$COURSE_ID/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{"status": "enrolling"}' > /dev/null

# ============================================================================
# 管理端测试 - 会员模块
# ============================================================================

print_header "管理端 - 会员模块"

# 27. 创建权益卡 - 正常
print_test "创建权益卡 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/member/cards" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "季卡",
        "type": "季卡",
        "price": 69.0,
        "duration_days": 90,
        "description": "季度会员卡,享受课程优惠价",
        "benefits": ["课程优惠价", "优先报名", "专属客服"],
        "is_recommended": true,
        "status": 1
    }')
check_response "$response" 0 "创建权益卡成功"
MEMBER_CARD_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Member Card ID: $MEMBER_CARD_ID"

# 28. 创建权益卡 - 负价格
print_test "创建权益卡 - 负价格"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/member/cards" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试卡",
        "type": "月卡",
        "price": -10.0,
        "duration_days": 30,
        "status": 1
    }')
check_response "$response" 10002 "负价格应该返回错误"

# 29. 获取权益卡列表 - 正常
print_test "获取权益卡列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/member/cards?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取权益卡列表成功"

# 30. 更新权益卡 - 正常
print_test "更新权益卡 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/member/cards/$MEMBER_CARD_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "季卡(特惠)",
        "type": "季卡",
        "price": 59.0,
        "duration_days": 90,
        "description": "季度会员卡,享受课程优惠价(特惠)",
        "benefits": ["课程优惠价", "优先报名", "专属客服", "生日礼物"],
        "is_recommended": true,
        "status": 1
    }')
check_response "$response" 0 "更新权益卡成功"

# ============================================================================
# 管理端测试 - 轮播图模块
# ============================================================================

print_header "管理端 - 轮播图模块"

# 31. 创建轮播图 - 正常
print_test "创建轮播图 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/banners" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "title": "国家体育总局指定考核点",
        "image": "https://example.com/banner1.jpg",
        "link": "",
        "sort": 1,
        "status": 1
    }')
check_response "$response" 0 "创建轮播图成功"
BANNER_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 32. 创建轮播图 - 缺少图片
print_test "创建轮播图 - 缺少图片"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/banners" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "title": "测试轮播图",
        "sort": 1,
        "status": 1
    }')
check_response "$response" 10002 "缺少图片应该返回错误"

# 33. 获取轮播图列表 - 正常
print_test "获取轮播图列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/banners?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取轮播图列表成功"

# 34. 更新轮播图 - 正常
print_test "更新轮播图 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/banners/$BANNER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "title": "国家体育总局指定考核点(已更新)",
        "image": "https://example.com/banner1_new.jpg",
        "link": "",
        "sort": 1,
        "status": 1
    }')
check_response "$response" 0 "更新轮播图成功"

# 35. 删除轮播图 - 正常
print_test "删除轮播图 - 正常"
response=$(curl -s -X DELETE "$API_BASE/api/v1/admin/banners/$BANNER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "删除轮播图成功"

# ============================================================================
# 管理端测试 - 仪表盘模块
# ============================================================================

print_header "管理端 - 仪表盘模块"

# 36. 获取统计数据 - 正常
print_test "获取统计数据 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/dashboard/stats" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取统计数据成功"

# 37. 获取最近订单 - 正常
print_test "获取最近订单 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/dashboard/recent-orders?limit=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取最近订单成功"

# ============================================================================
# 小程序端测试 - 认证模块
# ============================================================================

print_header "小程序端 - 认证模块"

# 38. 微信登录 - 正常(模拟)
print_test "微信登录 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/auth/wechat/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "code": "mock_wx_code_12345",
        "nickname": "测试用户",
        "avatar": "https://example.com/avatar.jpg"
    }')
check_response "$response" 0 "微信登录成功"
USER_TOKEN=$(echo "$response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)
USER_ID=$(echo "$response" | grep -o '"user_id":"[^"]*' | cut -d'"' -f4)
echo "User Token: ${USER_TOKEN:0:20}..."
echo "User ID: $USER_ID"

# 39. 微信登录 - 缺少code
print_test "微信登录 - 缺少code"
response=$(curl -s -X POST "$API_BASE/api/v1/auth/wechat/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "nickname": "测试用户"
    }')
check_response "$response" 10002 "缺少code应该返回错误"

# 40. 绑定手机号 - 正常
print_test "绑定手机号 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/auth/wechat/bindPhone" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "code": "mock_phone_code_12345"
    }')
check_response "$response" 0 "绑定手机号成功"

# 41. 绑定手机号 - 无Token
print_test "绑定手机号 - 无Token"
response=$(curl -s -X POST "$API_BASE/api/v1/auth/wechat/bindPhone" \
    -H "$CONTENT_TYPE" \
    -d '{
        "code": "mock_phone_code_12345"
    }')
check_response "$response" 10003 "无Token应该返回401"

# 42. 更新用户信息 - 正常
print_test "更新用户信息 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/auth/user/info" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "nickname": "测试用户(已更新)",
        "avatar": "https://example.com/avatar_new.jpg"
    }')
check_response "$response" 0 "更新用户信息成功"

# ============================================================================
# 小程序端测试 - 用户模块
# ============================================================================

print_header "小程序端 - 用户模块"

# 43. 获取用户信息 - 正常
print_test "获取用户信息 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/user/info" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取用户信息成功"

# 44. 获取用户信息 - 无Token
print_test "获取用户信息 - 无Token"
response=$(curl -s -X GET "$API_BASE/api/v1/user/info" \
    -H "$CONTENT_TYPE")
check_response "$response" 10003 "无Token应该返回401"

# 45. 获取用户资产 - 正常
print_test "获取用户资产 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/user/assets" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取用户资产成功"

# ============================================================================
# 小程序端测试 - 学员模块
# ============================================================================

print_header "小程序端 - 学员模块"

# 46. 添加学员 - 正常
print_test "添加学员 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小明",
        "id_number": "440301200001011234",
        "photo": "https://example.com/student.jpg",
        "birthday": "2015-05-20",
        "gender": "男"
    }')
check_response "$response" 0 "添加学员成功"
STUDENT_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Student ID: $STUDENT_ID"

# 47. 添加学员 - 缺少必填字段
print_test "添加学员 - 缺少必填字段"
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小红"
    }')
check_response "$response" 10002 "缺少必填字段应该返回错误"

# 48. 添加学员 - 无效身份证号
print_test "添加学员 - 无效身份证号"
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小红",
        "id_number": "123456",
        "birthday": "2015-05-20",
        "gender": "女"
    }')
check_response "$response" 10002 "无效身份证号应该返回错误"

# 49. 添加学员 - 未来日期
print_test "添加学员 - 未来日期"
future_date=$(date -u -d "+1 year" +"%Y-%m-%d" 2>/dev/null || date -u -v+1y +"%Y-%m-%d")
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"id_type\": \"身份证\",
        \"id_name\": \"张小蓝\",
        \"id_number\": \"440301200001011235\",
        \"birthday\": \"$future_date\",
        \"gender\": \"女\"
    }")
check_response "$response" 10002 "未来日期应该返回错误"

# 50. 获取学员列表 - 正常
print_test "获取学员列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取学员列表成功"

# 51. 更新学员 - 正常
print_test "更新学员 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/students/$STUDENT_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小明",
        "id_number": "440301200001011234",
        "photo": "https://example.com/student_new.jpg",
        "birthday": "2015-05-20",
        "gender": "男"
    }')
check_response "$response" 0 "更新学员成功"

# 52. 更新学员 - 不存在的ID
print_test "更新学员 - 不存在的ID"
response=$(curl -s -X PUT "$API_BASE/api/v1/students/nonexistent_student_id" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小明",
        "id_number": "440301200001011234",
        "birthday": "2015-05-20",
        "gender": "男"
    }')
check_response "$response" 10004 "不存在的ID应该返回404"

# ============================================================================
# 小程序端测试 - 小区模块
# ============================================================================

print_header "小程序端 - 小区模块"

# 53. 获取小区列表 - 正常
print_test "获取小区列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/communities?page=1&page_size=10" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取小区列表成功"

# 54. 获取小区列表 - 带搜索
print_test "获取小区列表 - 带搜索"
response=$(curl -s -G "$API_BASE/api/v1/communities" \
    --data-urlencode "page=1" \
    --data-urlencode "page_size=10" \
    --data-urlencode "keyword=测试" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "搜索小区成功"

# 55. 获取附近小区 - 正常
print_test "获取附近小区 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/communities/nearby?latitude=20.044220&longitude=110.199103&radius=5" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取附近小区成功"

# 56. 获取附近小区 - 缺少经纬度
print_test "获取附近小区 - 缺少经纬度"
response=$(curl -s -X GET "$API_BASE/api/v1/communities/nearby" \
    -H "$CONTENT_TYPE")
check_response "$response" 10002 "缺少经纬度应该返回错误"

# 57. 获取附近小区 - 无效经纬度
print_test "获取附近小区 - 无效经纬度"
response=$(curl -s -X GET "$API_BASE/api/v1/communities/nearby?latitude=200&longitude=300&radius=5" \
    -H "$CONTENT_TYPE")
check_response "$response" 10002 "无效经纬度应该返回错误"

# 58. 获取小区详情 - 正常
print_test "获取小区详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/communities/$COMMUNITY_ID" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取小区详情成功"

# 59. 获取小区详情 - 不存在的ID
print_test "获取小区详情 - 不存在的ID"
response=$(curl -s -X GET "$API_BASE/api/v1/communities/nonexistent_community_id" \
    -H "$CONTENT_TYPE")
check_response "$response" 10004 "不存在的ID应该返回404"

# ============================================================================
# 小程序端测试 - 课程模块
# ============================================================================

print_header "小程序端 - 课程模块"

# 60. 获取课程列表 - 正常
print_test "获取课程列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取课程列表成功"

# 61. 获取课程列表 - 按小区筛选
print_test "获取课程列表 - 按小区筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10&community_id=$COMMUNITY_ID" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "按小区筛选课程成功"

# 62. 获取课程列表 - 按状态筛选
print_test "获取课程列表 - 按状态筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10&status=enrolling" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "按状态筛选课程成功"

# 63. 获取课程列表 - 多条件筛选
print_test "获取课程列表 - 多条件筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10&community_id=$COMMUNITY_ID&status=enrolling" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "多条件筛选课程成功"

# 64. 获取课程详情 - 正常
print_test "获取课程详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/courses/$COURSE_ID" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取课程详情成功"

# 65. 获取课程详情 - 不存在的ID
print_test "获取课程详情 - 不存在的ID"
response=$(curl -s -X GET "$API_BASE/api/v1/courses/nonexistent_course_id" \
    -H "$CONTENT_TYPE")
check_response "$response" 10004 "不存在的ID应该返回404"

# ============================================================================
# 小程序端测试 - 订单模块
# ============================================================================

print_header "小程序端 - 订单模块"

# 66. 创建订单 - 正常
print_test "创建订单 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"$STUDENT_ID\"],
        \"use_member_price\": false
    }")
check_response "$response" 0 "创建订单成功"
ORDER_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
echo "Order ID: $ORDER_ID"

# 67. 创建订单 - 缺少课程ID
print_test "创建订单 - 缺少课程ID"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"student_ids\": [\"$STUDENT_ID\"]
    }")
check_response "$response" 10002 "缺少课程ID应该返回错误"

# 68. 创建订单 - 学员列表为空
print_test "创建订单 - 学员列表为空"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": []
    }")
check_response "$response" 10002 "学员列表为空应该返回错误"

# 69. 创建订单 - 不存在的课程
print_test "创建订单 - 不存在的课程"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"nonexistent_course_id\",
        \"student_ids\": [\"$STUDENT_ID\"]
    }")
check_response "$response" 10004 "不存在的课程应该返回404"

# 70. 创建订单 - 不存在的学员
print_test "创建订单 - 不存在的学员"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"nonexistent_student_id\"]
    }")
check_response "$response" 10004 "不存在的学员应该返回404"

# 71. 获取订单列表 - 正常
print_test "获取订单列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/orders?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取订单列表成功"

# 72. 获取订单列表 - 按状态筛选
print_test "获取订单列表 - 按状态筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/orders?page=1&page_size=10&status=pending" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "按状态筛选订单成功"

# 73. 获取订单详情 - 正常
print_test "获取订单详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/orders/$ORDER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取订单详情成功"

# 74. 获取订单详情 - 不存在的ID
print_test "获取订单详情 - 不存在的ID"
response=$(curl -s -X GET "$API_BASE/api/v1/orders/nonexistent_order_id" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 10004 "不存在的ID应该返回404"

# ============================================================================
# 小程序端测试 - 支付模块
# ============================================================================

print_header "小程序端 - 支付模块"

# 75. 获取支付参数 - 正常
print_test "获取支付参数 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/payment/prepay" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"order_id\": \"$ORDER_ID\"
    }")
check_response "$response" 0 "获取支付参数成功"

# 76. 获取支付参数 - 缺少订单ID
print_test "获取支付参数 - 缺少订单ID"
response=$(curl -s -X POST "$API_BASE/api/v1/payment/prepay" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{}')
check_response "$response" 10002 "缺少订单ID应该返回错误"

# 77. 获取支付参数 - 不存在的订单
print_test "获取支付参数 - 不存在的订单"
response=$(curl -s -X POST "$API_BASE/api/v1/payment/prepay" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "order_id": "nonexistent_order_id"
    }')
check_response "$response" 10004 "不存在的订单应该返回404"

# ============================================================================
# 小程序端测试 - 订单操作(取消/退款)
# ============================================================================

print_header "小程序端 - 订单操作"

# 先取消之前创建的订单，以便后续测试可以重新使用同一学员和课程
if [ -n "$ORDER_ID" ]; then
    echo "取消之前的订单: $ORDER_ID"
    curl -s -X POST "$API_BASE/api/v1/orders/$ORDER_ID/cancel" \
        -H "$CONTENT_TYPE" \
        -H "Authorization: Bearer $USER_TOKEN" \
        -d '{"reason": "测试准备: 取消旧订单"}' > /dev/null 2>&1
fi

# 创建一个新订单用于测试取消
print_test "创建测试订单用于取消"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"$STUDENT_ID\"],
        \"use_member_price\": false
    }")
check_response "$response" 0 "创建测试订单成功"
CANCEL_ORDER_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 78. 取消订单 - 正常
print_test "取消订单 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/orders/$CANCEL_ORDER_ID/cancel" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "reason": "时间冲突,无法参加"
    }')
check_response "$response" 0 "取消订单成功"

# 79. 取消订单 - 不存在的订单
print_test "取消订单 - 不存在的订单"
response=$(curl -s -X POST "$API_BASE/api/v1/orders/nonexistent_order_id/cancel" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "reason": "测试"
    }')
check_response "$response" 10004 "不存在的订单应该返回404"

# 80. 取消订单 - 已取消的订单
print_test "取消订单 - 已取消的订单"
response=$(curl -s -X POST "$API_BASE/api/v1/orders/$CANCEL_ORDER_ID/cancel" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "reason": "再次取消"
    }')
check_response "$response" 10005 "已取消的订单不能再次取消"

# 创建一个新订单并模拟支付,用于测试退款
print_test "创建测试订单用于退款"
response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"$STUDENT_ID\"],
        \"use_member_price\": false
    }")
check_response "$response" 0 "创建测试订单成功"
REFUND_ORDER_ID=$(echo "$response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 模拟支付成功(需要后端提供测试接口或直接更新数据库)
# 这里假设有一个测试接口
curl -s -X POST "$API_BASE/api/v1/test/pay-order" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{\"order_id\": \"$REFUND_ORDER_ID\"}" > /dev/null 2>&1

# 81. 申请退款 - 正常
print_test "申请退款 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/orders/$REFUND_ORDER_ID/refund" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "reason": "课程时间不合适"
    }')
check_response "$response" 0 "申请退款成功"

# 82. 申请退款 - 未支付的订单
print_test "申请退款 - 未支付的订单"
response=$(curl -s -X POST "$API_BASE/api/v1/orders/$ORDER_ID/refund" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "reason": "测试退款"
    }')
check_response "$response" 10006 "未支付的订单不能退款"

# ============================================================================
# 小程序端测试 - 会员模块
# ============================================================================

print_header "小程序端 - 会员模块"

# 83. 获取权益卡列表 - 正常
print_test "获取权益卡列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/member/cards" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取权益卡列表成功"

# 84. 购买权益卡 - 正常
print_test "购买权益卡 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/member/purchase" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"card_id\": \"$MEMBER_CARD_ID\"
    }")
check_response "$response" 0 "购买权益卡成功"

# 85. 购买权益卡 - 缺少卡片ID
print_test "购买权益卡 - 缺少卡片ID"
response=$(curl -s -X POST "$API_BASE/api/v1/member/purchase" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{}')
check_response "$response" 10002 "缺少卡片ID应该返回错误"

# 86. 购买权益卡 - 不存在的卡片
print_test "购买权益卡 - 不存在的卡片"
response=$(curl -s -X POST "$API_BASE/api/v1/member/purchase" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "card_id": "nonexistent_card_id"
    }')
check_response "$response" 10004 "不存在的卡片应该返回404"

# 87. 获取会员状态 - 正常
print_test "获取会员状态 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/member/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 0 "获取会员状态成功"

# 88. 获取会员状态 - 无Token
print_test "获取会员状态 - 无Token"
response=$(curl -s -X GET "$API_BASE/api/v1/member/status" \
    -H "$CONTENT_TYPE")
check_response "$response" 10003 "无Token应该返回401"

# ============================================================================
# 小程序端测试 - 轮播图模块
# ============================================================================

print_header "小程序端 - 轮播图模块"

# 先创建几个轮播图
curl -s -X POST "$API_BASE/api/v1/admin/banners" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "title": "国家体育总局指定考核点",
        "image": "https://example.com/banner1.jpg",
        "sort": 1,
        "status": 1
    }' > /dev/null

curl -s -X POST "$API_BASE/api/v1/admin/banners" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "title": "10万家庭的共同选择",
        "image": "https://example.com/banner2.jpg",
        "sort": 2,
        "status": 1
    }' > /dev/null

# 89. 获取轮播图列表 - 正常
print_test "获取轮播图列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/banners" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "获取轮播图列表成功"

# ============================================================================
# 小程序端测试 - 文件上传模块
# ============================================================================

print_header "小程序端 - 文件上传模块"

# 90. 上传图片 - 正常(需要实际文件,这里模拟)
print_test "上传图片 - 正常"
# 创建一个临时测试文件
echo "fake image data" > /tmp/test_image.jpg
response=$(curl -s -X POST "$API_BASE/api/v1/upload/image" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -F "file=@/tmp/test_image.jpg")
check_response "$response" 0 "上传图片成功"
rm -f /tmp/test_image.jpg

# 91. 上传图片 - 无文件
print_test "上传图片 - 无文件"
response=$(curl -s -X POST "$API_BASE/api/v1/upload/image" \
    -H "Authorization: Bearer $USER_TOKEN")
check_response "$response" 10002 "无文件应该返回错误"

# 92. 上传图片 - 文件过大(需要后端限制)
print_test "上传图片 - 文件过大"
# 创建一个大文件(模拟,实际测试需要真正的大文件)
dd if=/dev/zero of=/tmp/large_image.jpg bs=1M count=11 2>/dev/null
response=$(curl -s -X POST "$API_BASE/api/v1/upload/image" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -F "file=@/tmp/large_image.jpg")
check_response "$response" 10007 "文件过大应该返回错误"
rm -f /tmp/large_image.jpg

# 93. 上传图片 - 无效文件类型
print_test "上传图片 - 无效文件类型"
echo "not an image" > /tmp/test_file.txt
response=$(curl -s -X POST "$API_BASE/api/v1/upload/image" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -F "file=@/tmp/test_file.txt")
check_response "$response" 10008 "无效文件类型应该返回错误"
rm -f /tmp/test_file.txt

# ============================================================================
# 管理端测试 - 用户管理
# ============================================================================

print_header "管理端 - 用户管理"

# 94. 获取用户列表 - 正常
print_test "获取用户列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/users?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取用户列表成功"

# 95. 获取用户列表 - 带搜索
print_test "获取用户列表 - 带搜索"
response=$(curl -s -G "$API_BASE/api/v1/admin/users" \
    --data-urlencode "page=1" \
    --data-urlencode "page_size=10" \
    --data-urlencode "keyword=测试" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "搜索用户成功"

# 96. 获取用户详情 - 正常
print_test "获取用户详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/users/$USER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取用户详情成功"

# 97. 更新用户状态 - 正常
print_test "更新用户状态 - 正常"
response=$(curl -s -X PUT "$API_BASE/api/v1/admin/users/$USER_ID/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "status": 0
    }')
check_response "$response" 0 "更新用户状态成功"

# 恢复用户状态
curl -s -X PUT "$API_BASE/api/v1/admin/users/$USER_ID/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{"status": 1}' > /dev/null

# ============================================================================
# 管理端测试 - 学员管理
# ============================================================================

print_header "管理端 - 学员管理"

# 98. 获取学员列表 - 正常
print_test "获取学员列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/students?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取学员列表成功"

# 99. 获取学员列表 - 按用户筛选
print_test "获取学员列表 - 按用户筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/students?page=1&page_size=10&user_id=$USER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "按用户筛选学员成功"

# 100. 获取学员详情 - 正常
print_test "获取学员详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/students/$STUDENT_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取学员详情成功"

# ============================================================================
# 管理端测试 - 订单管理
# ============================================================================

print_header "管理端 - 订单管理"

# 101. 获取订单列表 - 正常
print_test "获取订单列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/orders?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取订单列表成功"

# 102. 获取订单列表 - 按状态筛选
print_test "获取订单列表 - 按状态筛选"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/orders?page=1&page_size=10&status=pending" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "按状态筛选订单成功"

# 103. 获取订单详情 - 正常
print_test "获取订单详情 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/orders/$ORDER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取订单详情成功"

# 104. 处理退款 - 正常
print_test "处理退款 - 正常"
response=$(curl -s -X POST "$API_BASE/api/v1/admin/orders/$REFUND_ORDER_ID/refund" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "approved": true,
        "remark": "同意退款"
    }')
check_response "$response" 0 "处理退款成功"

# ============================================================================
# 管理端测试 - 课程学员查询
# ============================================================================

print_header "管理端 - 课程学员管理"

# 105. 获取课程学员列表 - 正常
print_test "获取课程学员列表 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/courses/$COURSE_ID/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取课程学员列表成功"

# ============================================================================
# 管理端测试 - 会员购买记录
# ============================================================================

print_header "管理端 - 会员购买记录"

# 106. 获取会员购买记录 - 正常
print_test "获取会员购买记录 - 正常"
response=$(curl -s -X GET "$API_BASE/api/v1/admin/member/records?page=1&page_size=10" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "获取会员购买记录成功"

# ============================================================================
# 复杂场景测试 - 完整业务流程
# ============================================================================

print_header "复杂场景测试 - 完整业务流程"

# 107. 场景1: 新用户完整报名流程
print_test "场景1: 新用户完整报名流程"
# 1. 新用户登录
new_user_response=$(curl -s -X POST "$API_BASE/api/v1/auth/wechat/login" \
    -H "$CONTENT_TYPE" \
    -d '{
        "code": "mock_wx_code_new_user",
        "nickname": "新用户小王",
        "avatar": "https://example.com/avatar2.jpg"
    }')
new_user_token=$(echo "$new_user_response" | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. 添加学员
new_student_response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d '{
        "id_type": "身份证",
        "id_name": "王小二",
        "id_number": "440301201001011111",
        "birthday": "2016-03-15",
        "gender": "男"
    }')
new_student_id=$(echo "$new_student_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 3. 查看课程列表
curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10&status=enrolling" \
    -H "$CONTENT_TYPE" > /dev/null

# 4. 查看课程详情
curl -s -X GET "$API_BASE/api/v1/courses/$COURSE_ID" \
    -H "$CONTENT_TYPE" > /dev/null

# 5. 创建订单
new_order_response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"$new_student_id\"],
        \"use_member_price\": false
    }")
new_order_id=$(echo "$new_order_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 6. 获取支付参数
payment_response=$(curl -s -X POST "$API_BASE/api/v1/payment/prepay" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d "{
        \"order_id\": \"$new_order_id\"
    }")

# 7. 查看订单列表
curl -s -X GET "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" > /dev/null

check_response "$payment_response" 0 "场景1: 新用户完整报名流程"

# 取消场景1创建的订单，以便场景2可以重新报名
if [ -n "$new_order_id" ]; then
    curl -s -X POST "$API_BASE/api/v1/orders/$new_order_id/cancel" \
        -H "$CONTENT_TYPE" \
        -H "Authorization: Bearer $new_user_token" \
        -d '{"reason": "测试准备: 取消旧订单"}' > /dev/null 2>&1
fi

# 108. 场景2: 会员购买权益卡后优惠报名
print_test "场景2: 会员购买权益卡后优惠报名"
# 1. 查看权益卡列表
curl -s -X GET "$API_BASE/api/v1/member/cards" \
    -H "$CONTENT_TYPE" > /dev/null

# 2. 购买权益卡
member_response=$(curl -s -X POST "$API_BASE/api/v1/member/purchase" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d "{
        \"card_id\": \"$MEMBER_CARD_ID\"
    }")

# 3. 查看会员状态
curl -s -X GET "$API_BASE/api/v1/member/status" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" > /dev/null

# 4. 使用会员价创建订单
member_order_response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d "{
        \"course_id\": \"$COURSE_ID\",
        \"student_ids\": [\"$new_student_id\"],
        \"use_member_price\": true
    }")

check_response "$member_order_response" 0 "场景2: 会员购买权益卡后优惠报名"

# 109. 场景3: 管理员创建课程到用户报名
print_test "场景3: 管理员创建课程到用户报名"
# 1. 管理员创建小区
admin_community_response=$(curl -s -X POST "$API_BASE/api/v1/admin/communities" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "测试小区B",
        "address": "海口市龙华区测试路789号",
        "latitude": 20.050000,
        "longitude": 110.200000
    }')
admin_community_id=$(echo "$admin_community_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 2. 管理员创建教练
admin_teacher_response=$(curl -s -X POST "$API_BASE/api/v1/admin/teachers" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d '{
        "name": "小白老师",
        "status": 1
    }')
admin_teacher_id=$(echo "$admin_teacher_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 3. 管理员创建课程
admin_course_response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"篮球训练营\",
        \"age_range\": \"8-14岁\",
        \"community_id\": \"$admin_community_id\",
        \"teacher_id\": \"$admin_teacher_id\",
        \"total_weeks\": 8,
        \"total_lessons\": 8,
        \"schedule\": \"周日 09:00-10:00\",
        \"location\": \"小区篮球场\",
        \"price\": 100.0,
        \"member_price\": 50.0,
        \"min_students\": 6,
        \"max_students\": 12,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"status\": \"enrolling\"
    }")
admin_course_id=$(echo "$admin_course_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 4. 用户查看该课程
curl -s -X GET "$API_BASE/api/v1/courses/$admin_course_id" \
    -H "$CONTENT_TYPE" > /dev/null

# 5. 用户报名
final_order_response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $new_user_token" \
    -d "{
        \"course_id\": \"$admin_course_id\",
        \"student_ids\": [\"$new_student_id\"],
        \"use_member_price\": true
    }")

check_response "$final_order_response" 0 "场景3: 管理员创建课程到用户报名"

# 110. 场景4: 附近小区搜索并筛选课程
print_test "场景4: 附近小区搜索并筛选课程"
# 1. 搜索附近小区
nearby_response=$(curl -s -X GET "$API_BASE/api/v1/communities/nearby?latitude=20.044220&longitude=110.199103&radius=10" \
    -H "$CONTENT_TYPE")

# 2. 选择某个小区查看课程
selected_community_id=$(echo "$nearby_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)
community_courses_response=$(curl -s -X GET "$API_BASE/api/v1/courses?community_id=$selected_community_id&status=enrolling" \
    -H "$CONTENT_TYPE")

check_response "$community_courses_response" 0 "场景4: 附近小区搜索并筛选课程"

# 111. 场景5: 订单状态变更流程
print_test "场景5: 订单状态变更流程"

# 为场景5创建专用课程
deadline_date=$(date -v+30d '+%Y-%m-%d')
start_date=$(date -v+7d '+%Y-%m-%d')
end_date=$(date -v+37d '+%Y-%m-%d')

scenario5_course_response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"场景5测试课程\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"category\": \"体能\",
        \"age_range\": \"4-8岁\",
        \"schedule\": \"周日 10:00-11:00\",
        \"price\": 50.00,
        \"member_price\": 40.00,
        \"min_students\": 5,
        \"max_students\": 15,
        \"total_weeks\": 8,
        \"total_lessons\": 8,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"status\": \"enrolling\"
    }")
scenario5_course_id=$(echo "$scenario5_course_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 1. 创建订单(pending)
status_order_response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$scenario5_course_id\",
        \"student_ids\": [\"$STUDENT_ID\"],
        \"use_member_price\": false
    }")
status_order_id=$(echo "$status_order_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 2. 获取支付参数
curl -s -X POST "$API_BASE/api/v1/payment/prepay" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{\"order_id\": \"$status_order_id\"}" > /dev/null

# 3. 模拟支付成功(paid)
curl -s -X POST "$API_BASE/api/v1/test/pay-order" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{\"order_id\": \"$status_order_id\"}" > /dev/null 2>&1

# 4. 查看订单状态
paid_order_response=$(curl -s -X GET "$API_BASE/api/v1/orders/$status_order_id" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")

check_response "$paid_order_response" 0 "场景5: 订单状态变更流程"

# 112. 场景6: 多学员同时报名
print_test "场景6: 多学员同时报名"

# 为场景6创建专用课程
scenario6_course_response=$(curl -s -X POST "$API_BASE/api/v1/admin/courses" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN" \
    -d "{
        \"name\": \"场景6测试课程\",
        \"community_id\": \"$COMMUNITY_ID\",
        \"teacher_id\": \"$TEACHER_ID\",
        \"category\": \"体能\",
        \"age_range\": \"4-8岁\",
        \"schedule\": \"周日 14:00-15:00\",
        \"price\": 45.00,
        \"member_price\": 35.00,
        \"min_students\": 5,
        \"max_students\": 20,
        \"total_weeks\": 8,
        \"total_lessons\": 8,
        \"deadline\": \"$deadline_date\",
        \"start_date\": \"$start_date\",
        \"end_date\": \"$end_date\",
        \"status\": \"enrolling\"
    }")
scenario6_course_id=$(echo "$scenario6_course_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 1. 添加第二个学员
student2_response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小红",
        "id_number": "440301201101011112",
        "birthday": "2016-06-10",
        "gender": "女"
    }')
student2_id=$(echo "$student2_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 2. 同时为两个学员报名
multi_student_order_response=$(curl -s -X POST "$API_BASE/api/v1/orders" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"course_id\": \"$scenario6_course_id\",
        \"student_ids\": [\"$STUDENT_ID\", \"$student2_id\"],
        \"use_member_price\": false
    }")

check_response "$multi_student_order_response" 0 "场景6: 多学员同时报名"

# 113. 场景7: 学员信息更新
print_test "场景7: 学员信息更新"
# 1. 获取学员信息
curl -s -X GET "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" > /dev/null

# 2. 更新学员照片
update_student_response=$(curl -s -X PUT "$API_BASE/api/v1/students/$STUDENT_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "张小明",
        "id_number": "440301200001011234",
        "photo": "https://example.com/student_updated.jpg",
        "birthday": "2015-05-20",
        "gender": "男"
    }')

# 3. 验证更新
verify_response=$(curl -s -X GET "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")

check_response "$verify_response" 0 "场景7: 学员信息更新"

# 114. 场景8: 删除学员
print_test "场景8: 删除学员(已删除临时教练)"
# 先创建一个临时学员
temp_student_response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "临时学员",
        "id_number": "440301201201011113",
        "birthday": "2016-08-01",
        "gender": "男"
    }')
temp_student_id=$(echo "$temp_student_response" | grep -o '"id":"[^"]*' | head -1 | cut -d'"' -f4)

# 删除学员
delete_student_response=$(curl -s -X DELETE "$API_BASE/api/v1/students/$temp_student_id" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN")

check_response "$delete_student_response" 0 "场景8: 删除学员"

# 115. 场景9: 管理员查看用户详细信息
print_test "场景9: 管理员查看用户详细信息"
# 1. 获取用户详情
user_detail_response=$(curl -s -X GET "$API_BASE/api/v1/admin/users/$USER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")

# 2. 获取用户的学员列表
user_students_response=$(curl -s -X GET "$API_BASE/api/v1/admin/students?user_id=$USER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")

# 3. 获取用户的订单列表
user_orders_response=$(curl -s -X GET "$API_BASE/api/v1/admin/orders?user_id=$USER_ID" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")

check_response "$user_orders_response" 0 "场景9: 管理员查看用户详细信息"

# 116. 场景10: 分页功能测试
print_test "场景10: 分页功能测试"
# 1. 第一页
page1_response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=5" \
    -H "$CONTENT_TYPE")

# 2. 第二页
page2_response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=2&page_size=5" \
    -H "$CONTENT_TYPE")

# 3. 无效页码(应该返回空列表或第一页)
invalid_page_response=$(curl -s -X GET "$API_BASE/api/v1/courses?page=999&page_size=5" \
    -H "$CONTENT_TYPE")

check_response "$invalid_page_response" 0 "场景10: 分页功能测试"

# ============================================================================
# 边界测试
# ============================================================================

print_header "边界测试"

# 117. SQL注入测试
print_test "SQL注入测试"
response=$(curl -s -G "$API_BASE/api/v1/courses" \
    --data-urlencode "keyword='; DROP TABLE courses; --" \
    -H "$CONTENT_TYPE")
check_response "$response" 0 "SQL注入防护"

# 118. XSS测试
print_test "XSS测试"
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d '{
        "id_type": "身份证",
        "id_name": "<script>alert(\"XSS\")</script>",
        "id_number": "440301201301011114",
        "birthday": "2016-09-01",
        "gender": "男"
    }')
# 应该被转义或拒绝
check_response "$response" 0 "XSS防护(应该被转义)"

# 119. 超长字符串测试
print_test "超长字符串测试"
long_string=$(python3 -c "print('A' * 10000)")
response=$(curl -s -X POST "$API_BASE/api/v1/students" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $USER_TOKEN" \
    -d "{
        \"id_type\": \"身份证\",
        \"id_name\": \"$long_string\",
        \"id_number\": \"440301201401011115\",
        \"birthday\": \"2016-10-01\",
        \"gender\": \"男\"
    }")
check_response "$response" 10002 "超长字符串应该被拒绝"

# 120. 并发请求测试
print_test "并发请求测试"
for i in {1..10}; do
    curl -s -X GET "$API_BASE/api/v1/courses?page=1&page_size=10" \
        -H "$CONTENT_TYPE" > /dev/null &
done
wait
print_success "并发请求测试(10个请求)"
((TOTAL_TESTS++))
((PASSED_TESTS++))

# ============================================================================
# 输出测试总结
# ============================================================================

print_summary
