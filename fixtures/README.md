# API 测试用例使用说明

## 概述

本目录包含义城上门教育项目的API接口测试用例,使用curl命令进行黑盒测试。

## 测试文件

- `api.test` - 完整的API测试用例集(120个测试用例)

## 测试覆盖

### 接口覆盖
- ✅ 小程序端接口: 25个
- ✅ 管理端接口: 32个
- ✅ 总计: 57个API接口

### 测试类型
- ✅ 正常功能测试
- ✅ 异常测试(参数校验、权限测试、边界测试)
- ✅ 复杂场景测试(完整业务流程)
- ✅ 安全测试(SQL注入、XSS防护)
- ✅ 性能测试(并发请求)

## 前置条件

### 1. 启动后端服务

```bash
cd backend
uv run uvicorn src.main:app --reload
```

服务应该运行在 `http://localhost:8000`

### 2. 初始化数据库

确保已执行数据库初始化脚本:

```bash
mysql -u root -p < sqls/spot.sql
```

默认管理员账号:
- 用户名: `admin`
- 密码: `admin123`

## 执行测试

### 运行全部测试

```bash
cd /Users/chenlehua/workspace/spot
bash fixtures/api.test
```

### 查看测试输出

测试会输出:
- ✅ 每个测试的执行结果(通过/失败)
- 📊 最终的测试总结(总计、通过、失败)
- 🔍 失败测试的详细响应信息

示例输出:
```
============================================================
  管理端 - 认证模块
============================================================

[TEST 1] 管理员登录 - 正常
✓ PASS: 管理员登录成功
Admin Token: eyJhbGciOiJIUzI1NiIs...

[TEST 2] 管理员登录 - 错误密码
✓ PASS: 错误密码应该返回错误码

...

============================================================
  测试总结
============================================================
总计: 120
通过: 120
失败: 0

所有测试通过!
```

## 测试用例说明

### 基础测试
- 健康检查接口

### 管理端测试
1. **认证模块**: 登录、获取信息、权限验证
2. **小区模块**: CRUD操作、参数校验
3. **教练模块**: CRUD操作、删除测试
4. **课程模块**: CRUD操作、状态管理、业务校验
5. **会员模块**: 权益卡管理、价格校验
6. **轮播图模块**: CRUD操作
7. **仪表盘模块**: 统计数据、最近订单
8. **用户管理**: 用户列表、详情、状态管理
9. **学员管理**: 学员列表、详情、用户筛选
10. **订单管理**: 订单列表、详情、退款处理

### 小程序端测试
1. **认证模块**: 微信登录、绑定手机号、更新信息
2. **用户模块**: 用户信息、用户资产
3. **学员模块**: 增删改查、身份证校验、日期校验
4. **小区模块**: 列表查询、附近小区(距离计算)、详情
5. **课程模块**: 列表筛选(小区、状态)、详情
6. **订单模块**: 创建订单、订单列表、取消、退款
7. **支付模块**: 获取支付参数
8. **会员模块**: 权益卡列表、购买、会员状态
9. **轮播图**: 轮播图列表
10. **文件上传**: 上传图片、文件校验

### 复杂场景测试
1. **场景1**: 新用户完整报名流程(登录→添加学员→创建订单→支付)
2. **场景2**: 会员购买权益卡后优惠报名
3. **场景3**: 管理员创建课程到用户报名(完整流程)
4. **场景4**: 附近小区搜索并筛选课程
5. **场景5**: 订单状态变更流程(pending→paid)
6. **场景6**: 多学员同时报名
7. **场景7**: 学员信息更新
8. **场景8**: 删除学员
9. **场景9**: 管理员查看用户详细信息(用户+学员+订单)
10. **场景10**: 分页功能测试

### 边界测试
1. SQL注入防护测试
2. XSS攻击防护测试
3. 超长字符串测试
4. 并发请求测试

## 测试数据

测试过程中会自动创建以下测试数据:

### 管理端数据
- 小区: 测试小区A、测试小区B
- 教练: 小黑老师、小白老师
- 课程: 体能+跳绳、篮球训练营
- 权益卡: 季卡
- 轮播图: 若干轮播图

### 用户端数据
- 用户: 测试用户、新用户小王
- 学员: 张小明、王小二、张小红等
- 订单: 若干测试订单

## 错误码参考

测试用例中使用的错误码:

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 10001 | 认证失败(用户名或密码错误) |
| 10002 | 参数错误(缺少必填字段、格式错误等) |
| 10003 | 未授权(无Token或Token无效) |
| 10004 | 资源不存在(404) |
| 10005 | 业务逻辑错误(如重复操作) |
| 10006 | 状态错误(如未支付订单申请退款) |
| 10007 | 文件过大 |
| 10008 | 文件类型错误 |

## 注意事项

1. **测试环境隔离**: 建议在测试环境运行,避免污染生产数据
2. **数据清理**: 每次测试会创建大量测试数据,建议定期清理
3. **并发测试**: 并发测试可能对服务器造成压力,注意监控
4. **修改测试**: 如需修改测试用例,请编辑 `api.test` 文件
5. **Token过期**: Token默认有效期为2小时,长时间运行可能需要重新获取

## 问题排查

### 测试失败

1. **检查服务是否启动**
   ```bash
   curl http://localhost:8000/health
   ```

2. **检查数据库连接**
   - 确认MySQL服务运行
   - 确认数据库已初始化
   - 检查环境变量配置

3. **查看后端日志**
   - 检查后端服务输出的错误日志
   - 查看具体的错误堆栈

4. **API变更**
   - 如果API接口有变更,需要更新测试用例
   - 检查响应格式是否与预期一致

### 网络问题

如果出现连接超时:
- 检查端口是否被占用
- 确认防火墙设置
- 调整curl超时时间

## 扩展测试

如需添加新的测试用例:

1. 参考现有测试用例格式
2. 使用 `print_test` 输出测试名称
3. 使用 `check_response` 验证响应
4. 更新测试计数

示例:
```bash
print_test "新测试用例"
response=$(curl -s -X GET "$API_BASE/api/v1/new-endpoint" \
    -H "$CONTENT_TYPE" \
    -H "Authorization: Bearer $ADMIN_TOKEN")
check_response "$response" 0 "新测试用例描述"
```

## 持续集成

可以将此测试集成到CI/CD流程:

```yaml
# .github/workflows/api-test.yml
name: API Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup MySQL
        run: |
          # 初始化数据库
      - name: Start Backend
        run: |
          cd backend
          uv run uvicorn src.main:app &
          sleep 5
      - name: Run API Tests
        run: bash fixtures/api.test
```

## 贡献指南

如需贡献新的测试用例:

1. Fork项目
2. 创建测试分支
3. 添加测试用例
4. 确保所有测试通过
5. 提交Pull Request

---

**文档版本**: v1.0
**最后更新**: 2026-01-31
**维护者**: 开发团队
