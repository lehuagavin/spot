# 义城上门教育 - 系统详细设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 产品名称 | 义城上门教育 (Yicheng Home Education) |
| 版本 | v1.0 (MVP) |
| 文档类型 | 系统详细设计 |
| 文档状态 | 初稿 |

---

## 1. 整体设计

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────┐              ┌─────────────────────┐            │
│    │   微信小程序 (用户端)  │              │   管理后台 (Web)     │            │
│    │                     │              │                     │            │
│    │  ┌───────────────┐  │              │  ┌───────────────┐  │            │
│    │  │  首页模块      │  │              │  │  课程管理      │  │            │
│    │  │  课程模块      │  │              │  │  订单管理      │  │            │
│    │  │  订单模块      │  │              │  │  用户管理      │  │            │
│    │  │  用户模块      │  │              │  │  小区管理      │  │            │
│    │  │  支付模块      │  │              │  │  系统配置      │  │            │
│    │  └───────────────┘  │              │  └───────────────┘  │            │
│    └─────────────────────┘              └─────────────────────┘            │
│                                                                             │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │ HTTPS / WebSocket
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              网关层 (Gateway Layer)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────────────────────────────────────────────┐     │
│    │                        API Gateway                               │     │
│    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │     │
│    │  │ 路由转发 │  │ 限流控制 │  │ 身份认证 │  │ 日志记录 │            │     │
│    │  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │     │
│    └─────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              服务层 (Service Layer)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐         │
│  │ 用户服务  │ │ 课程服务  │ │ 订单服务  │ │ 支付服务  │ │ 通知服务  │         │
│  │          │ │          │ │          │ │          │ │          │         │
│  │ - 注册   │ │ - 列表   │ │ - 创建   │ │ - 下单   │ │ - 模板   │         │
│  │ - 登录   │ │ - 详情   │ │ - 查询   │ │ - 回调   │ │ - 推送   │         │
│  │ - 信息   │ │ - 搜索   │ │ - 取消   │ │ - 退款   │ │          │         │
│  │ - 学员   │ │ - 报名   │ │ - 退款   │ │ - 查询   │ │          │         │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘         │
│                                                                             │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                                    │
│  │ 小区服务  │ │ 会员服务  │ │ 文件服务  │                                    │
│  │          │ │          │ │          │                                    │
│  │ - 列表   │ │ - 权益卡 │ │ - 上传   │                                    │
│  │ - 搜索   │ │ - 购买   │ │ - 下载   │                                    │
│  │ - 详情   │ │ - 查询   │ │          │                                    │
│  └──────────┘ └──────────┘ └──────────┘                                    │
│                                                                             │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据层 (Data Layer)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────┐    ┌─────────────────────────┐              │
│    │         MySQL           │    │       本地文件存储        │              │
│    │                         │    │                         │              │
│    │  - 业务数据              │    │  - 上传图片              │              │
│    │  - 用户数据              │    │  - 课程图片              │              │
│    │  - 订单数据              │    │  - 静态资源              │              │
│    └─────────────────────────┘    └─────────────────────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           第三方服务 (Third-party Services)                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌─────────────────────────────┐    ┌─────────────────────────────┐     │
│    │        微信开放平台          │    │          微信支付            │     │
│    │                             │    │                             │     │
│    │  - 登录授权                  │    │  - 统一下单                  │     │
│    │  - 消息推送                  │    │  - 支付回调                  │     │
│    │  - 小程序码                  │    │  - 退款接口                  │     │
│    │  - 内置地图组件 (免费)        │    │                             │     │
│    │  - 内置定位API (免费)        │    │                             │     │
│    └─────────────────────────────┘    └─────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 1.2.1 前端技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 小程序框架 | 原生微信小程序 / Taro | 跨端开发框架 |
| UI 组件库 | Vant Weapp | 轻量、可靠的小程序 UI 组件库 |
| 状态管理 | MobX | 简单、可扩展的状态管理 |
| 网络请求 | wx.request 封装 | 统一请求拦截、错误处理 |
| 地图服务 | 小程序内置 map 组件 + wx.getLocation | 免费，无需商业授权 |

#### 1.2.2 后端技术栈

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 开发语言 | Python 3.12+ | 快速开发、丰富生态 |
| Web 框架 | FastAPI | 高性能异步框架 |
| ORM | SQLAlchemy 2.0 | 异步 ORM 支持 |
| 数据库 | MySQL 8.0 | 关系型数据库 |
| 包管理 | uv | 快速的 Python 包管理器 |
| 文件存储 | 本地文件系统 | 图片、文件本地存储 |

#### 1.2.3 基础设施（本地开发环境）

| 组件 | 配置 | 说明 |
|------|------|------|
| 数据库 | 本地 MySQL 8.0 | 开发环境数据库 |
| 文件存储 | 本地 uploads 目录 | 图片、文件存储 |
| 日志 | 本地文件 + 控制台 | 开发调试日志 |

### 1.3 系统分层设计

```
┌────────────────────────────────────────────────────────────────┐
│                      表现层 (Presentation Layer)                │
│                                                                │
│   ┌──────────────────────────────────────────────────────┐    │
│   │  API Router  │  Request/Response Models  │  Validators │    │
│   └──────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                      业务层 (Business Layer)                    │
│                                                                │
│   ┌──────────────────────────────────────────────────────┐    │
│   │   Services   │   Business Logic   │   Domain Models  │    │
│   └──────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                      数据访问层 (Data Access Layer)              │
│                                                                │
│   ┌──────────────────────────────────────────────────────┐    │
│   │  Repositories  │  ORM Models  │  Database Connections │    │
│   └──────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────┐
│                      基础设施层 (Infrastructure Layer)           │
│                                                                │
│   ┌──────────────────────────────────────────────────────┐    │
│   │   MySQL   │   本地文件存储   │   External APIs        │    │
│   └──────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────┘
```

---

## 2. 前端模块设计

### 2.1 小程序目录结构

```
miniprogram/
├── app.js                    # 小程序入口
├── app.json                  # 全局配置
├── app.wxss                  # 全局样式
├── sitemap.json              # 小程序索引配置
│
├── components/               # 公共组件
│   ├── course-card/          # 课程卡片组件
│   ├── empty-state/          # 空状态组件
│   ├── loading/              # 加载组件
│   ├── navbar/               # 自定义导航栏
│   ├── student-card/         # 学员卡片组件
│   ├── tab-bar/              # 自定义底部导航
│   └── price-display/        # 价格展示组件
│
├── pages/                    # 页面
│   ├── index/                # 首页
│   ├── course/               # 课程相关
│   │   ├── list/             # 课程列表
│   │   └── detail/           # 课程详情
│   ├── order/                # 订单相关
│   │   ├── confirm/          # 确认订单
│   │   ├── pay/              # 支付页面
│   │   └── list/             # 订单列表
│   ├── student/              # 学员相关
│   │   ├── list/             # 学员列表
│   │   ├── add/              # 新增学员
│   │   └── select/           # 选择学员
│   ├── community/            # 小区相关
│   │   ├── map/              # 地图页面
│   │   └── list/             # 小区列表
│   ├── member/               # 会员相关
│   │   └── rights/           # 权益卡页面
│   ├── user/                 # 用户相关
│   │   ├── index/            # 个人中心
│   │   ├── login/            # 登录页面
│   │   └── about/            # 关于我们
│   └── webview/              # H5 页面容器
│
├── services/                 # 服务层
│   ├── api.js                # API 基础封装
│   ├── user.js               # 用户相关 API
│   ├── course.js             # 课程相关 API
│   ├── order.js              # 订单相关 API
│   ├── community.js          # 小区相关 API
│   └── payment.js            # 支付相关 API
│
├── store/                    # 状态管理
│   ├── index.js              # Store 入口
│   ├── user.js               # 用户状态
│   ├── location.js           # 位置状态
│   └── cart.js               # 购物车状态
│
├── utils/                    # 工具函数
│   ├── request.js            # 网络请求封装
│   ├── auth.js               # 认证相关
│   ├── storage.js            # 本地存储
│   ├── format.js             # 格式化工具
│   ├── validate.js           # 表单验证
│   └── location.js           # 位置相关 (封装 wx.getLocation)
│
├── constants/                # 常量定义
│   ├── api.js                # API 地址
│   ├── storage-keys.js       # 存储键名
│   └── enums.js              # 枚举值
│
└── assets/                   # 静态资源
    ├── images/               # 图片资源
    ├── icons/                # 图标资源
    └── styles/               # 公共样式
```

### 2.2 页面组件图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                   App                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          TabBar Navigation                           │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐               │   │
│  │  │  首页   │  │ 权益卡  │  │  拼班   │  │  我的   │               │   │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘               │   │
│  └───────┼────────────┼────────────┼────────────┼───────────────────────┘   │
│          │            │            │            │                           │
│          ▼            ▼            ▼            ▼                           │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐                   │
│  │  HomePage │ │ RightsPage│ │ ClassPage │ │  MyPage   │                   │
│  │           │ │           │ │           │ │           │                   │
│  │ ┌───────┐ │ │ ┌───────┐ │ │ ┌───────┐ │ │ ┌───────┐ │                   │
│  │ │Banner │ │ │ │Card   │ │ │ │Tabs   │ │ │ │Profile│ │                   │
│  │ │Swiper │ │ │ │Display│ │ │ │Filter │ │ │ │Header │ │                   │
│  │ └───────┘ │ │ └───────┘ │ │ └───────┘ │ │ └───────┘ │                   │
│  │ ┌───────┐ │ │ ┌───────┐ │ │ ┌───────┐ │ │ ┌───────┐ │                   │
│  │ │Course │ │ │ │Rights │ │ │ │Class  │ │ │ │Assets │ │                   │
│  │ │Filter │ │ │ │Desc   │ │ │ │List   │ │ │ │Card   │ │                   │
│  │ └───────┘ │ │ └───────┘ │ │ └───────┘ │ │ └───────┘ │                   │
│  │ ┌───────┐ │ │           │ │           │ │ ┌───────┐ │                   │
│  │ │Course │ │ │           │ │           │ │ │Menu   │ │                   │
│  │ │List   │ │ │           │ │           │ │ │Grid   │ │                   │
│  │ └───────┘ │ │           │ │           │ │ └───────┘ │                   │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            子页面组件结构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  CourseDetail   │    │   OrderConfirm  │    │   StudentSelect │         │
│  │                 │    │                 │    │                 │         │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │         │
│  │ │ CourseHeader│ │    │ │ CourseInfo  │ │    │ │ StudentList │ │         │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │         │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │         │
│  │ │ TeacherInfo │ │    │ │StudentSelect│ │    │ │ StudentCard │ │         │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │         │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │         │
│  │ │ ScheduleInfo│ │    │ │ PriceDetail │ │    │ │ ActionBar   │ │         │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │         │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    └─────────────────┘         │
│  │ │ PricePanel  │ │    │ │ Agreement   │ │                                │
│  │ └─────────────┘ │    │ └─────────────┘ │    ┌─────────────────┐         │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │   StudentAdd    │         │
│  │ │ EnrollInfo  │ │    │ │ PayButton   │ │    │                 │         │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ ┌─────────────┐ │         │
│  │ ┌─────────────┐ │    └─────────────────┘    │ │ FormFields  │ │         │
│  │ │ ActionBar   │ │                           │ └─────────────┘ │         │
│  │ └─────────────┘ │                           │ ┌─────────────┐ │         │
│  └─────────────────┘                           │ │ PhotoUpload │ │         │
│                                                │ └─────────────┘ │         │
│                                                │ ┌─────────────┐ │         │
│                                                │ │ SubmitBtn   │ │         │
│                                                │ └─────────────┘ │         │
│                                                └─────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 状态管理设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Global Store                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                           UserStore                                    │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │ State:                                                          │  │ │
│  │  │   - isLoggedIn: boolean        # 登录状态                        │  │ │
│  │  │   - userInfo: UserInfo | null  # 用户信息                        │  │ │
│  │  │   - token: string | null       # 访问令牌                        │  │ │
│  │  │   - students: Student[]        # 学员列表                        │  │ │
│  │  │   - isMember: boolean          # 会员状态                        │  │ │
│  │  ├─────────────────────────────────────────────────────────────────┤  │ │
│  │  │ Actions:                                                        │  │ │
│  │  │   - login()                    # 登录                           │  │ │
│  │  │   - logout()                   # 登出                           │  │ │
│  │  │   - updateUserInfo()           # 更新用户信息                    │  │ │
│  │  │   - fetchStudents()            # 获取学员列表                    │  │ │
│  │  │   - addStudent()               # 添加学员                        │  │ │
│  │  │   - deleteStudent()            # 删除学员                        │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         LocationStore                                  │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │ State:                                                          │  │ │
│  │  │   - currentLocation: Location  # 当前位置                        │  │ │
│  │  │   - selectedCommunity: Community | null  # 选中小区             │  │ │
│  │  │   - nearbyCommunitites: Community[]  # 附近小区列表             │  │ │
│  │  ├─────────────────────────────────────────────────────────────────┤  │ │
│  │  │ Actions:                                                        │  │ │
│  │  │   - getCurrentLocation()       # 获取当前位置                    │  │ │
│  │  │   - selectCommunity()          # 选择小区                        │  │ │
│  │  │   - fetchNearbyCommunities()   # 获取附近小区                    │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                           OrderStore                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │ │
│  │  │ State:                                                          │  │ │
│  │  │   - currentOrder: OrderDraft   # 当前订单草稿                    │  │ │
│  │  │   - selectedStudents: Student[] # 已选学员                       │  │ │
│  │  │   - orderList: Order[]         # 订单列表                        │  │ │
│  │  ├─────────────────────────────────────────────────────────────────┤  │ │
│  │  │ Actions:                                                        │  │ │
│  │  │   - setCurrentCourse()         # 设置当前课程                    │  │ │
│  │  │   - selectStudents()           # 选择学员                        │  │ │
│  │  │   - calculatePrice()           # 计算价格                        │  │ │
│  │  │   - submitOrder()              # 提交订单                        │  │ │
│  │  │   - fetchOrderList()           # 获取订单列表                    │  │ │
│  │  └─────────────────────────────────────────────────────────────────┘  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 管理后台 Web 设计

### 3.1 技术选型

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| 框架 | React 18 | 主流前端框架，生态丰富 |
| 构建工具 | Vite | 快速的开发构建工具 |
| UI 组件库 | Ant Design 5.x | 企业级中后台组件库 |
| 状态管理 | Zustand | 轻量级状态管理 |
| 路由 | React Router 6 | 声明式路由 |
| 网络请求 | Axios | HTTP 客户端 |
| 图表 | ECharts | 数据可视化 |
| 表单 | Ant Design Form | 表单处理 |
| 表格 | Ant Design ProTable | 高级表格组件 |
| 语言 | TypeScript | 类型安全 |

### 3.2 项目目录结构

```
admin-web/
├── public/                   # 静态资源
│   └── favicon.ico
├── src/
│   ├── main.tsx              # 应用入口
│   ├── App.tsx               # 根组件
│   ├── vite-env.d.ts         # Vite 类型声明
│   │
│   ├── api/                  # API 接口
│   │   ├── index.ts          # API 基础配置
│   │   ├── auth.ts           # 认证接口
│   │   ├── user.ts           # 用户管理接口
│   │   ├── student.ts        # 学员管理接口
│   │   ├── course.ts         # 课程管理接口
│   │   ├── order.ts          # 订单管理接口
│   │   ├── community.ts      # 小区管理接口
│   │   ├── member.ts         # 会员管理接口
│   │   └── system.ts         # 系统配置接口
│   │
│   ├── components/           # 公共组件
│   │   ├── Layout/           # 布局组件
│   │   │   ├── index.tsx
│   │   │   ├── Header.tsx
│   │   │   ├── Sider.tsx
│   │   │   └── Footer.tsx
│   │   ├── AuthGuard/        # 权限守卫
│   │   ├── ImageUpload/      # 图片上传
│   │   ├── RichEditor/       # 富文本编辑器
│   │   └── ExportButton/     # 导出按钮
│   │
│   ├── pages/                # 页面
│   │   ├── login/            # 登录页
│   │   ├── dashboard/        # 首页仪表盘
│   │   ├── user/             # 用户管理
│   │   │   ├── list/         # 用户列表
│   │   │   └── detail/       # 用户详情
│   │   ├── student/          # 学员管理
│   │   │   └── list/
│   │   ├── course/           # 课程管理
│   │   │   ├── list/         # 课程列表
│   │   │   ├── create/       # 创建课程
│   │   │   └── edit/         # 编辑课程
│   │   ├── order/            # 订单管理
│   │   │   ├── list/         # 订单列表
│   │   │   └── detail/       # 订单详情
│   │   ├── community/        # 小区管理
│   │   │   ├── list/
│   │   │   └── form/
│   │   ├── member/           # 会员管理
│   │   │   ├── card/         # 权益卡管理
│   │   │   └── record/       # 会员记录
│   │   ├── agent/            # 主理人管理
│   │   │   ├── list/
│   │   │   └── audit/        # 审核
│   │   ├── teacher/          # 教练管理
│   │   │   ├── list/
│   │   │   └── form/
│   │   ├── system/           # 系统设置
│   │   │   ├── banner/       # 轮播图管理
│   │   │   ├── config/       # 系统配置
│   │   │   └── admin/        # 管理员管理
│   │   └── 403.tsx           # 无权限页
│   │
│   ├── hooks/                # 自定义 Hooks
│   │   ├── useAuth.ts        # 认证 Hook
│   │   ├── usePermission.ts  # 权限 Hook
│   │   └── useTable.ts       # 表格 Hook
│   │
│   ├── store/                # 状态管理
│   │   ├── index.ts
│   │   ├── auth.ts           # 认证状态
│   │   └── app.ts            # 应用状态
│   │
│   ├── router/               # 路由配置
│   │   ├── index.tsx
│   │   └── routes.tsx
│   │
│   ├── types/                # 类型定义
│   │   ├── api.ts            # API 类型
│   │   ├── user.ts
│   │   ├── course.ts
│   │   └── order.ts
│   │
│   ├── utils/                # 工具函数
│   │   ├── request.ts        # 请求封装
│   │   ├── auth.ts           # 认证工具
│   │   ├── format.ts         # 格式化
│   │   └── export.ts         # 导出工具
│   │
│   └── styles/               # 样式
│       ├── global.css
│       └── variables.css
│
├── index.html
├── vite.config.ts
├── tsconfig.json
├── package.json
└── .env.example
```

### 3.3 页面设计

#### 3.3.1 页面结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              管理后台布局                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                            Header                                    │   │
│  │  ┌─────────┐                                      ┌───────────────┐ │   │
│  │  │  Logo   │                                      │ 用户信息 | 退出 │ │   │
│  │  └─────────┘                                      └───────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────┐  ┌─────────────────────────────────────────────────────┐  │
│  │             │  │                                                     │  │
│  │   Sider     │  │                    Content                          │  │
│  │             │  │                                                     │  │
│  │  ┌───────┐  │  │  ┌─────────────────────────────────────────────┐   │  │
│  │  │ 仪表盘 │  │  │  │                 Breadcrumb                  │   │  │
│  │  ├───────┤  │  │  └─────────────────────────────────────────────┘   │  │
│  │  │用户管理│  │  │                                                     │  │
│  │  ├───────┤  │  │  ┌─────────────────────────────────────────────┐   │  │
│  │  │学员管理│  │  │  │                                             │   │  │
│  │  ├───────┤  │  │  │                                             │   │  │
│  │  │课程管理│  │  │  │              Page Content                   │   │  │
│  │  ├───────┤  │  │  │                                             │   │  │
│  │  │订单管理│  │  │  │                                             │   │  │
│  │  ├───────┤  │  │  │                                             │   │  │
│  │  │小区管理│  │  │  │                                             │   │  │
│  │  ├───────┤  │  │  │                                             │   │  │
│  │  │会员管理│  │  │  └─────────────────────────────────────────────┘   │  │
│  │  ├───────┤  │  │                                                     │  │
│  │  │主理人  │  │  └─────────────────────────────────────────────────────┘  │
│  │  ├───────┤  │                                                           │
│  │  │教练管理│  │                                                           │
│  │  ├───────┤  │                                                           │
│  │  │系统设置│  │                                                           │
│  │  └───────┘  │                                                           │
│  │             │                                                           │
│  └─────────────┘                                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 核心页面设计

##### 仪表盘 (Dashboard)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  仪表盘                                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  今日订单    │  │  本月收入    │  │  用户总数    │  │  进行中课程  │       │
│  │     12      │  │   ¥8,560    │  │    1,234    │  │     25      │       │
│  │   ↑ 20%    │  │   ↑ 15%    │  │   ↑ 8%     │  │   ↓ 5%     │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│  ┌───────────────────────────────────┐  ┌───────────────────────────────┐  │
│  │          订单趋势图（7天）          │  │        收入统计（本月）        │  │
│  │                                   │  │                               │  │
│  │         [ECharts 折线图]          │  │       [ECharts 柱状图]        │  │
│  │                                   │  │                               │  │
│  └───────────────────────────────────┘  └───────────────────────────────┘  │
│                                                                             │
│  ┌───────────────────────────────────┐  ┌───────────────────────────────┐  │
│  │           最近订单                 │  │         待处理事项             │  │
│  │  ┌─────┬──────┬──────┬──────┐   │  │  • 3 个退款申请待处理          │  │
│  │  │订单号│ 用户  │ 金额  │ 状态 │   │  │  • 5 个主理人申请待审核        │  │
│  │  ├─────┼──────┼──────┼──────┤   │  │  • 2 个课程即将截止报名        │  │
│  │  │ ... │ ...  │ ...  │ ...  │   │  │                               │  │
│  │  └─────┴──────┴──────┴──────┘   │  └───────────────────────────────┘  │
│  └───────────────────────────────────┘                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### 课程管理 - 列表页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  课程管理 > 课程列表                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  搜索条件                                                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐              │   │
│  │  │ 课程名称  │ │ 所属小区  │ │ 课程状态  │ │ 创建时间  │  [搜索] [重置] │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  [+ 新建课程]  [导出]                                                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ □ │ 课程名称      │ 小区   │ 教练  │ 价格  │ 报名  │ 状态  │ 操作    │   │
│  ├───┼───────────────┼────────┼──────┼──────┼──────┼──────┼─────────┤   │
│  │ □ │(7-12岁)体能   │ 蓝水湾 │小黑   │ ¥80  │ 3/10 │拼班中 │编辑 删除 │   │
│  │ □ │(7-12岁)跳绳   │ 皇御苑 │小白   │ ¥80  │ 8/10 │待开课 │编辑 删除 │   │
│  │ □ │(5-8岁)篮球    │ 蓝水湾 │小明   │ ¥100 │10/10 │开班中 │编辑 查看 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  共 25 条记录                                    < 1  2  3  4  5 >          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### 课程管理 - 创建/编辑页

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  课程管理 > 新建课程                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  基本信息                                                            │   │
│  │                                                                     │   │
│  │  课程名称 *    [________________________]                           │   │
│  │                                                                     │   │
│  │  课程图片 *    [上传图片]  (建议尺寸: 750x400)                        │   │
│  │                                                                     │   │
│  │  适合年龄 *    [最小年龄 ▼]  至  [最大年龄 ▼]                        │   │
│  │                                                                     │   │
│  │  所属小区 *    [请选择小区 ▼]                                        │   │
│  │                                                                     │   │
│  │  授课教练 *    [请选择教练 ▼]                                        │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  课程安排                                                            │   │
│  │                                                                     │   │
│  │  总周数 *      [____] 周       总课时 *    [____] 节                 │   │
│  │                                                                     │   │
│  │  上课时间 *    [星期几 ▼]  [开始时间]  至  [结束时间]                 │   │
│  │                                                                     │   │
│  │  上课地点      [________________________________]                    │   │
│  │                                                                     │   │
│  │  报名截止 *    [日期选择器]                                          │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  价格与人数                                                          │   │
│  │                                                                     │   │
│  │  课程原价 *    ¥ [______]  /节                                      │   │
│  │                                                                     │   │
│  │  会员价格 *    ¥ [______]  /节                                      │   │
│  │                                                                     │   │
│  │  最低开班 *    [____] 人      最大人数 *    [____] 人                │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│                                              [取消]  [保存草稿]  [发布]     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### 小区管理 - 列表与表单

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  小区管理                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [+ 新建小区]                                                                │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ │ 小区图片  │ 小区名称  │ 地址           │ 经纬度        │ 操作     │   │
│  ├─┼──────────┼──────────┼───────────────┼──────────────┼──────────┤   │
│  │ │ [图片]   │ 皇御苑    │ 福田区福田街道7号│ 22.54,114.05 │编辑 删除  │   │
│  │ │ [图片]   │ 蓝水湾    │ 南山区蛇口街道  │ 22.48,113.92 │编辑 删除  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  新建小区 (Modal)                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  小区名称 *    [________________________]                                   │
│                                                                             │
│  小区图片 *    [上传图片]                                                    │
│                                                                             │
│  详细地址 *    [________________________________________]                   │
│                                                                             │
│  经度 *        [____________]     纬度 *    [____________]                  │
│                                                                             │
│               [在地图上选择位置] (点击打开地图选点)                            │
│                                                                             │
│  所属城市      [省 ▼]  [市 ▼]  [区 ▼]                                       │
│                                                                             │
│                                              [取消]  [确定]                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### 订单管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  订单管理                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  订单状态统计                                                         │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │   │
│  │  │ 全部     │ │ 待支付   │ │ 已支付   │ │ 退款中   │ │ 已退款   │      │   │
│  │  │  156    │ │   12    │ │   120   │ │    5    │ │   19    │      │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  [订单号/手机号搜索]  [课程 ▼]  [状态 ▼]  [日期范围]  [搜索]  [导出]   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │订单号          │用户      │课程        │金额   │状态  │时间     │操作 │   │
│  ├────────────────┼─────────┼───────────┼──────┼─────┼────────┼─────┤   │
│  │202601311234567│136****89│(7-12)体能  │¥80.00│已支付│01-31 12│详情 │   │
│  │202601301234568│139****56│(7-12)跳绳  │¥80.00│退款中│01-30 10│处理 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##### 轮播图管理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  系统设置 > 轮播图管理                                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [+ 新建轮播图]                                                              │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  拖拽排序                                                            │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ ≡ │ [预览图] │ 国家体育总局指定考核点 │ 启用 │ 编辑  删除 │ ↑ ↓ │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ ≡ │ [预览图] │ 专业场地多方扶持      │ 启用 │ 编辑  删除 │ ↑ ↓ │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │ ≡ │ [预览图] │ 10万家庭的共同选择    │ 禁用 │ 编辑  删除 │ ↑ ↓ │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 权限设计

#### 3.4.1 角色定义

MVP 版本仅支持单一管理员角色，拥有全部权限。

| 角色 | 说明 | 权限范围 |
|------|------|----------|
| admin | 管理员 | 全部权限 |

#### 3.4.2 默认管理员账号

系统初始化时自动创建默认管理员账号：

| 字段 | 值 |
|------|------|
| 用户名 | admin |
| 密码 | admin123 (首次登录需修改) |
| 姓名 | 系统管理员 |

**数据库初始化 SQL**：
```sql
INSERT INTO admins (id, username, password_hash, name, status, created_at, updated_at)
VALUES (
  'admin_001',
  'admin',
  -- bcrypt hash of 'admin123'
  '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.VTtYr6D1HwXHHm',
  '系统管理员',
  1,
  NOW(),
  NOW()
);
```

#### 3.4.3 菜单配置

管理员可访问所有菜单：

```typescript
const menuConfig: MenuItem[] = [
  {
    key: 'dashboard',
    title: '仪表盘',
    icon: 'DashboardOutlined',
    path: '/dashboard'
  },
  {
    key: 'user',
    title: '用户管理',
    icon: 'UserOutlined',
    children: [
      { key: 'user-list', title: '用户列表', path: '/user/list' },
      { key: 'student-list', title: '学员列表', path: '/student/list' }
    ]
  },
  {
    key: 'course',
    title: '课程管理',
    icon: 'BookOutlined',
    children: [
      { key: 'course-list', title: '课程列表', path: '/course/list' },
      { key: 'teacher-list', title: '教练管理', path: '/teacher/list' }
    ]
  },
  {
    key: 'order',
    title: '订单管理',
    icon: 'OrderedListOutlined',
    path: '/order/list'
  },
  {
    key: 'community',
    title: '小区管理',
    icon: 'HomeOutlined',
    path: '/community/list'
  },
  {
    key: 'member',
    title: '会员管理',
    icon: 'CrownOutlined',
    children: [
      { key: 'member-card', title: '权益卡管理', path: '/member/card' },
      { key: 'member-record', title: '会员记录', path: '/member/record' }
    ]
  },
  {
    key: 'agent',
    title: '主理人管理',
    icon: 'TeamOutlined',
    path: '/agent/list'
  },
  {
    key: 'system',
    title: '系统设置',
    icon: 'SettingOutlined',
    children: [
      { key: 'banner', title: '轮播图管理', path: '/system/banner' },
      { key: 'config', title: '系统配置', path: '/system/config' }
    ]
  }
];
```


### 3.5 管理端 API 接口

#### 3.5.1 认证接口

##### 管理员登录

```
POST /api/admin/v1/auth/login
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 7200,
    "admin": {
      "id": "a_001",
      "username": "admin",
      "name": "管理员",
      "role": "super_admin",
      "permissions": ["*"]
    }
  }
}
```

##### 获取当前管理员信息

```
GET /api/admin/v1/auth/me
```

#### 3.5.2 小区管理接口

##### 小区列表

```
GET /api/admin/v1/communities
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 搜索关键词 |
| city | string | 否 | 城市筛选 |
| status | number | 否 | 状态：1启用 0禁用 |
| page | number | 否 | 页码 |
| page_size | number | 否 | 每页数量 |

##### 创建小区

```
POST /api/admin/v1/communities
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 小区名称 |
| address | string | 是 | 详细地址 |
| image | string | 是 | 小区图片URL |
| latitude | number | 是 | 纬度 |
| longitude | number | 是 | 经度 |
| province | string | 否 | 省份 |
| city | string | 否 | 城市 |
| district | string | 否 | 区县 |

##### 更新小区

```
PUT /api/admin/v1/communities/{id}
```

##### 删除小区

```
DELETE /api/admin/v1/communities/{id}
```

#### 3.5.3 课程管理接口

##### 课程列表

```
GET /api/admin/v1/courses
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 课程名称搜索 |
| community_id | string | 否 | 小区ID |
| teacher_id | string | 否 | 教练ID |
| status | string | 否 | 课程状态 |
| page | number | 否 | 页码 |
| page_size | number | 否 | 每页数量 |

##### 创建课程

```
POST /api/admin/v1/courses
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 课程名称 |
| image | string | 是 | 课程图片 |
| community_id | string | 是 | 小区ID |
| teacher_id | string | 是 | 教练ID |
| age_min | number | 是 | 最小年龄 |
| age_max | number | 是 | 最大年龄 |
| total_weeks | number | 是 | 总周数 |
| total_lessons | number | 是 | 总课时 |
| schedule_day | string | 是 | 上课日 |
| schedule_start | string | 是 | 开始时间 |
| schedule_end | string | 是 | 结束时间 |
| location | string | 否 | 上课地点详情 |
| price | number | 是 | 原价 |
| member_price | number | 是 | 会员价 |
| min_students | number | 是 | 最低开班人数 |
| max_students | number | 是 | 最大人数 |
| deadline | string | 是 | 报名截止时间 |

##### 更新课程

```
PUT /api/admin/v1/courses/{id}
```

##### 更新课程状态

```
PATCH /api/admin/v1/courses/{id}/status
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 是 | 新状态 |

##### 删除课程

```
DELETE /api/admin/v1/courses/{id}
```

#### 3.5.4 订单管理接口

##### 订单列表

```
GET /api/admin/v1/orders
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 订单号/手机号 |
| course_id | string | 否 | 课程ID |
| status | string | 否 | 订单状态 |
| start_date | string | 否 | 开始日期 |
| end_date | string | 否 | 结束日期 |
| page | number | 否 | 页码 |
| page_size | number | 否 | 每页数量 |

##### 订单详情

```
GET /api/admin/v1/orders/{id}
```

##### 订单统计

```
GET /api/admin/v1/orders/statistics
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 156,
    "pending": 12,
    "paid": 120,
    "refunding": 5,
    "refunded": 19
  }
}
```

##### 处理退款

```
POST /api/admin/v1/orders/{id}/refund
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| action | string | 是 | approve/reject |
| reason | string | 否 | 处理备注 |

##### 导出订单

```
GET /api/admin/v1/orders/export
```

返回 Excel 文件下载。

#### 3.5.5 用户管理接口

##### 用户列表

```
GET /api/admin/v1/users
```

##### 用户详情

```
GET /api/admin/v1/users/{id}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "u_123456",
    "phone": "13692238295",
    "nickname": "张三",
    "avatar": "https://...",
    "health_beans": 100,
    "is_member": true,
    "member_expire_at": "2026-04-30",
    "created_at": "2026-01-01",
    "students": [...],
    "orders": [...],
    "statistics": {
      "total_orders": 5,
      "total_amount": 400.00
    }
  }
}
```

##### 用户学员列表

```
GET /api/admin/v1/users/{id}/students
```

##### 用户订单列表

```
GET /api/admin/v1/users/{id}/orders
```

#### 3.5.6 教练管理接口

##### 教练列表

```
GET /api/admin/v1/teachers
```

##### 创建教练

```
POST /api/admin/v1/teachers
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 姓名 |
| avatar | string | 否 | 头像 |
| phone | string | 否 | 手机号 |
| intro | string | 否 | 简介 |

##### 更新教练

```
PUT /api/admin/v1/teachers/{id}
```

##### 删除教练

```
DELETE /api/admin/v1/teachers/{id}
```

#### 3.5.7 轮播图管理接口

##### 轮播图列表

```
GET /api/admin/v1/banners
```

##### 创建轮播图

```
POST /api/admin/v1/banners
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| title | string | 否 | 标题 |
| image | string | 是 | 图片URL |
| link | string | 否 | 跳转链接 |
| link_type | string | 否 | 链接类型: page/webview/none |
| sort_order | number | 否 | 排序 |
| status | number | 否 | 状态 |

##### 更新轮播图

```
PUT /api/admin/v1/banners/{id}
```

##### 批量排序

```
PUT /api/admin/v1/banners/sort
```

**请求参数**:
```json
{
  "items": [
    { "id": "b_001", "sort_order": 1 },
    { "id": "b_002", "sort_order": 2 }
  ]
}
```

##### 删除轮播图

```
DELETE /api/admin/v1/banners/{id}
```

#### 3.5.8 仪表盘接口

##### 统计概览

```
GET /api/admin/v1/dashboard/overview
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "today_orders": 12,
    "today_orders_change": 0.2,
    "month_revenue": 8560.00,
    "month_revenue_change": 0.15,
    "total_users": 1234,
    "total_users_change": 0.08,
    "active_courses": 25,
    "active_courses_change": -0.05
  }
}
```

##### 订单趋势

```
GET /api/admin/v1/dashboard/order-trend
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| days | number | 否 | 天数，默认7 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "dates": ["01-25", "01-26", "01-27", ...],
    "orders": [5, 8, 12, ...],
    "revenue": [400, 640, 960, ...]
  }
}
```

##### 待处理事项

```
GET /api/admin/v1/dashboard/todos
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "pending_refunds": 3,
    "pending_agents": 5,
    "expiring_courses": 2
  }
}
```

---

## 4. 后端模块设计

### 4.1 项目目录结构

```
backend/
├── pyproject.toml            # 项目配置
├── uv.lock                   # 依赖锁定文件
├── alembic.ini               # 数据库迁移配置
├── .env.example              # 环境变量示例
│
├── src/
│   ├── __init__.py
│   ├── main.py               # 应用入口
│   │
│   ├── api/                  # API 路由层
│   │   ├── __init__.py
│   │   ├── deps.py           # 依赖注入
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── router.py     # 路由聚合
│   │       └── endpoints/
│   │           ├── __init__.py
│   │           ├── auth.py       # 认证接口
│   │           ├── users.py      # 用户接口
│   │           ├── students.py   # 学员接口
│   │           ├── courses.py    # 课程接口
│   │           ├── orders.py     # 订单接口
│   │           ├── payments.py   # 支付接口
│   │           ├── communities.py # 小区接口
│   │           └── members.py    # 会员接口
│   │
│   ├── core/                 # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py         # 应用配置
│   │   ├── security.py       # 安全相关
│   │   ├── logging.py        # 日志配置
│   │   └── exceptions.py     # 自定义异常
│   │
│   ├── models/               # 数据模型
│   │   ├── __init__.py
│   │   ├── base.py           # 基础模型
│   │   ├── user.py           # 用户模型
│   │   ├── student.py        # 学员模型
│   │   ├── course.py         # 课程模型
│   │   ├── order.py          # 订单模型
│   │   ├── community.py      # 小区模型
│   │   └── member.py         # 会员模型
│   │
│   ├── schemas/              # Pydantic Schemas
│   │   ├── __init__.py
│   │   ├── common.py         # 通用 Schema
│   │   ├── auth.py           # 认证 Schema
│   │   ├── user.py           # 用户 Schema
│   │   ├── student.py        # 学员 Schema
│   │   ├── course.py         # 课程 Schema
│   │   ├── order.py          # 订单 Schema
│   │   ├── community.py      # 小区 Schema
│   │   └── member.py         # 会员 Schema
│   │
│   ├── services/             # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── auth_service.py   # 认证服务
│   │   ├── user_service.py   # 用户服务
│   │   ├── student_service.py # 学员服务
│   │   ├── course_service.py # 课程服务
│   │   ├── order_service.py  # 订单服务
│   │   ├── payment_service.py # 支付服务
│   │   ├── community_service.py # 小区服务
│   │   └── member_service.py # 会员服务
│   │
│   ├── repositories/         # 数据访问层
│   │   ├── __init__.py
│   │   ├── base.py           # 基础仓储
│   │   ├── user_repo.py      # 用户仓储
│   │   ├── student_repo.py   # 学员仓储
│   │   ├── course_repo.py    # 课程仓储
│   │   ├── order_repo.py     # 订单仓储
│   │   ├── community_repo.py # 小区仓储
│   │   └── member_repo.py    # 会员仓储
│   │
│   ├── utils/                # 工具函数
│   │   ├── __init__.py
│   │   ├── wechat.py         # 微信相关工具
│   │   ├── payment.py        # 支付工具
│   │   ├── crypto.py         # 加密工具
│   │   ├── validators.py     # 验证工具
│   │   ├── geo.py            # 地理计算工具 (Haversine 距离计算)
│   │   └── helpers.py        # 辅助函数
│   │
│   └── tasks/                # 异步任务
│       ├── __init__.py
│       ├── celery_app.py     # Celery 配置
│       ├── order_tasks.py    # 订单相关任务
│       └── notification_tasks.py # 通知相关任务
│
├── migrations/               # 数据库迁移
│   └── versions/
│
└── tests/                    # 测试
    ├── __init__.py
    ├── conftest.py
    ├── test_auth.py
    ├── test_users.py
    ├── test_courses.py
    └── test_orders.py
```

### 4.2 模块职责划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              模块职责划分图                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         认证模块 (Auth Module)                       │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 微信小程序登录                                                    │   │
│  │  • 手机号获取与绑定                                                  │   │
│  │  • JWT Token 生成与验证                                             │   │
│  │  • 用户会话管理                                                      │   │
│  │                                                                     │   │
│  │  依赖：微信开放平台 API                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         用户模块 (User Module)                       │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 用户信息管理（CRUD）                                              │   │
│  │  • 用户资产管理（健康豆、优惠券）                                     │   │
│  │  • 用户偏好设置                                                      │   │
│  │                                                                     │   │
│  │  依赖：认证模块                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         学员模块 (Student Module)                    │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 学员信息管理（CRUD）                                              │   │
│  │  • 学员身份验证                                                      │   │
│  │  • 学员照片管理                                                      │   │
│  │                                                                     │   │
│  │  依赖：用户模块、文件服务                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         课程模块 (Course Module)                     │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 课程信息管理                                                      │   │
│  │  • 课程列表查询与筛选                                                │   │
│  │  • 课程状态管理                                                      │   │
│  │  • 报名人数统计                                                      │   │
│  │                                                                     │   │
│  │  依赖：小区模块                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         订单模块 (Order Module)                      │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 订单创建与管理                                                    │   │
│  │  • 订单状态流转                                                      │   │
│  │  • 订单价格计算                                                      │   │
│  │  • 订单超时处理                                                      │   │
│  │  • 退款处理                                                          │   │
│  │                                                                     │   │
│  │  依赖：课程模块、学员模块、支付模块、会员模块                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         支付模块 (Payment Module)                    │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 微信支付统一下单                                                  │   │
│  │  • 支付结果回调处理                                                  │   │
│  │  • 退款申请与处理                                                    │   │
│  │  • 支付记录管理                                                      │   │
│  │                                                                     │   │
│  │  依赖：微信支付 API、订单模块                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         小区模块 (Community Module)                  │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 小区信息管理（后台配置，含经纬度）                                 │   │
│  │  • 附近小区查询（按距离排序）                                        │   │
│  │  • 小区距离计算（后端 Haversine 公式）                               │   │
│  │                                                                     │   │
│  │  依赖：无外部地图服务（使用小程序内置定位获取用户坐标）               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         会员模块 (Member Module)                     │   │
│  │                                                                     │   │
│  │  职责：                                                              │   │
│  │  • 权益卡管理                                                        │   │
│  │  • 会员购买                                                          │   │
│  │  • 会员权益查询                                                      │   │
│  │  • 会员价格计算                                                      │   │
│  │                                                                     │   │
│  │  依赖：支付模块、用户模块                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 模块依赖关系图

```
                                ┌─────────────┐
                                │   认证模块   │
                                └──────┬──────┘
                                       │
                                       ▼
                                ┌─────────────┐
                                │   用户模块   │
                                └──────┬──────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
                    ▼                  ▼                  ▼
             ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
             │   学员模块   │   │   会员模块   │   │   小区模块   │
             └──────┬──────┘   └──────┬──────┘   └─────────────┘
                    │                  │                  │
                    │                  │                  │
                    │          ┌───────┴───────┐         │
                    │          │               │         │
                    ▼          ▼               │         ▼
             ┌─────────────────────────┐       │   (后端距离计算)
             │       课程模块          │◄──────┘   (Haversine)
             └───────────┬─────────────┘
                         │
                         ▼
             ┌─────────────────────────┐
             │       订单模块          │
             └───────────┬─────────────┘
                         │
                         ▼
             ┌─────────────────────────┐
             │       支付模块          │
             └───────────┬─────────────┘
                         │
                         ▼
             ┌─────────────────────────┐
             │     微信支付服务         │
             └─────────────────────────┘

说明：小区模块不依赖外部地图服务，使用小程序内置 wx.getLocation
获取用户坐标，后端使用 Haversine 公式计算距离，无需商业授权。
```

---

## 5. 接口设计

### 5.1 API 设计规范

#### 5.1.1 URL 规范

```
基础路径: /api/v1

资源命名规则:
- 使用小写字母
- 使用连字符分隔单词
- 使用复数形式表示资源集合
- 使用 ID 表示单个资源

示例:
GET    /api/v1/courses              # 获取课程列表
GET    /api/v1/courses/{id}         # 获取课程详情
POST   /api/v1/orders               # 创建订单
PUT    /api/v1/students/{id}        # 更新学员信息
DELETE /api/v1/students/{id}        # 删除学员
```

#### 5.1.2 响应格式规范

**成功响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 业务数据
  }
}
```

**分页响应**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "total_pages": 5
  }
}
```

**错误响应**:
```json
{
  "code": 10001,
  "message": "参数验证失败",
  "details": {
    "field": "phone",
    "error": "手机号格式不正确"
  }
}
```

#### 5.1.3 错误码设计

| 错误码范围 | 说明 |
|-----------|------|
| 0 | 成功 |
| 10000-10999 | 通用错误 |
| 11000-11999 | 认证相关错误 |
| 12000-12999 | 用户相关错误 |
| 13000-13999 | 课程相关错误 |
| 14000-14999 | 订单相关错误 |
| 15000-15999 | 支付相关错误 |

**详细错误码**:

| 错误码 | 说明 |
|--------|------|
| 10001 | 参数验证失败 |
| 10002 | 资源不存在 |
| 10003 | 操作失败 |
| 11001 | Token 无效 |
| 11002 | Token 过期 |
| 11003 | 未登录 |
| 11004 | 无权限 |
| 12001 | 用户不存在 |
| 12002 | 手机号已注册 |
| 13001 | 课程不存在 |
| 13002 | 课程已结束 |
| 13003 | 课程名额已满 |
| 14001 | 订单不存在 |
| 14002 | 订单状态异常 |
| 14003 | 订单已取消 |
| 15001 | 支付失败 |
| 15002 | 退款失败 |

### 5.2 认证模块接口

#### 5.2.1 微信登录

```
POST /api/v1/auth/wechat-login
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | string | 是 | 微信登录凭证 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "expires_in": 7200,
    "user": {
      "id": "u_123456",
      "phone": null,
      "nickname": null,
      "avatar": null,
      "is_new_user": true
    }
  }
}
```

#### 5.2.2 绑定手机号

```
POST /api/v1/auth/bindphone
```

**请求头**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| Authorization | string | 是 | Bearer {token} |

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | string | 是 | 手机号获取凭证 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "phone": "13692238295"
  }
}
```

#### 5.2.3 更新用户信息

```
PUT /api/v1/auth/userinfo
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| nickname | string | 否 | 用户昵称 |
| avatar | string | 否 | 头像URL |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "u_123456",
    "phone": "13692238295",
    "nickname": "张三",
    "avatar": "https://..."
  }
}
```

### 5.3 用户模块接口

#### 5.3.1 获取用户信息

```
GET /api/v1/users/me
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "u_123456",
    "phone": "13692238295",
    "nickname": "张三",
    "avatar": "https://...",
    "health_beans": 100,
    "coupon_count": 2,
    "is_member": true,
    "member_expire_at": "2026-12-31T23:59:59Z",
    "created_at": "2026-01-01T00:00:00Z"
  }
}
```

#### 5.3.2 获取用户资产

```
GET /api/v1/users/me/assets
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "health_beans": 100,
    "coupons": [
      {
        "id": "c_001",
        "name": "新人优惠券",
        "type": "discount",
        "value": 10,
        "min_amount": 50,
        "expire_at": "2026-03-01T23:59:59Z"
      }
    ]
  }
}
```

### 5.4 学员模块接口

#### 5.4.1 获取学员列表

```
GET /api/v1/students
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "s_001",
        "name": "陈乐华",
        "id_type": "id_card",
        "id_number": "4401**********1234",
        "photo": "https://...",
        "birthday": "2015-06-15",
        "gender": "male",
        "age": 10,
        "member_type": "normal"
      }
    ],
    "total": 1
  }
}
```

#### 5.4.2 添加学员

```
POST /api/v1/students
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id_type | string | 是 | 证件类型：id_card |
| id_name | string | 是 | 证件姓名 |
| id_number | string | 是 | 证件号码 |
| photo | string | 否 | 照片URL |
| birthday | string | 是 | 出生日期 YYYY-MM-DD |
| gender | string | 是 | 性别：male/female |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "s_002",
    "name": "张小明",
    "id_type": "id_card",
    "id_number": "4401**********5678",
    "photo": null,
    "birthday": "2016-03-20",
    "gender": "male",
    "age": 9,
    "member_type": "normal"
  }
}
```

#### 5.4.3 删除学员

```
DELETE /api/v1/students/{student_id}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": null
}
```

### 5.5 小区模块接口

#### 5.5.1 获取小区列表

```
GET /api/v1/communities
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | 否 | 搜索关键词 |
| latitude | number | 否 | 当前纬度 |
| longitude | number | 否 | 当前经度 |
| page | number | 否 | 页码，默认1 |
| page_size | number | 否 | 每页数量，默认20 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "cm_001",
        "name": "皇御苑",
        "address": "福田区福田街道7号",
        "image": "https://...",
        "latitude": 22.5431,
        "longitude": 114.0579,
        "distance": 1245.5
      }
    ],
    "total": 10,
    "page": 1,
    "page_size": 20
  }
}
```

#### 5.5.2 获取小区详情

```
GET /api/v1/communities/{community_id}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "cm_001",
    "name": "皇御苑",
    "address": "福田区福田街道7号",
    "image": "https://...",
    "latitude": 22.5431,
    "longitude": 114.0579,
    "course_count": 5
  }
}
```

### 5.6 课程模块接口

#### 5.6.1 获取课程列表

```
GET /api/v1/courses
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| community_id | string | 否 | 小区ID |
| status | string | 否 | 状态：all/ongoing/ended |
| page | number | 否 | 页码，默认1 |
| page_size | number | 否 | 每页数量，默认20 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "cr_001",
        "name": "(7-12岁) 体能+跳绳",
        "image": "https://...",
        "age_range": "7-12",
        "schedule": "周六 08:00-09:00",
        "price": 80.00,
        "member_price": 39.80,
        "min_students": 4,
        "max_students": 10,
        "enrolled_count": 3,
        "status": "enrolling",
        "community": {
          "id": "cm_001",
          "name": "蓝水湾"
        }
      }
    ],
    "total": 5,
    "page": 1,
    "page_size": 20
  }
}
```

#### 5.6.2 获取课程详情

```
GET /api/v1/courses/{course_id}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "cr_001",
    "name": "(7-12岁) 体能+跳绳",
    "image": "https://...",
    "age_range": "7-12",
    "teacher": {
      "id": "t_001",
      "name": "小黑老师",
      "avatar": "https://..."
    },
    "total_weeks": 10,
    "total_lessons": 10,
    "current_week": 1,
    "schedule": "周六 08:00-09:00",
    "location": "海口市海南省海口市美兰区桂林横路",
    "price": 80.00,
    "member_price": 39.80,
    "min_students": 4,
    "max_students": 10,
    "enrolled_count": 3,
    "remaining_slots": 7,
    "deadline": "2026-01-31T08:00:00Z",
    "status": "enrolling",
    "enrolled_students": [
      {
        "id": "s_001",
        "avatar": "https://..."
      }
    ],
    "community": {
      "id": "cm_001",
      "name": "蓝水湾",
      "address": "..."
    },
    "rules": [
      "支付成功即视为拼班成功",
      "所支付的费用为该产品的实际价格",
      "报名时间截止前随时可申请退款，报名时间截止后费用不退",
      "若遇到不可抗拒因素该班将解散，费用将自动原路返还"
    ]
  }
}
```

### 5.7 订单模块接口

#### 5.7.1 创建订单

```
POST /api/v1/orders
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| course_id | string | 是 | 课程ID |
| student_ids | array | 是 | 学员ID列表 |
| coupon_id | string | 否 | 优惠券ID |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "o_001",
    "order_no": "202601311234567890",
    "course": {
      "id": "cr_001",
      "name": "(7-12岁) 体能+跳绳"
    },
    "students": [
      {
        "id": "s_001",
        "name": "陈乐华",
        "price": 80.00,
        "discount_price": 9.90,
        "is_new_user": true
      }
    ],
    "total_amount": 80.00,
    "discount_amount": 70.10,
    "pay_amount": 9.90,
    "status": "pending",
    "expire_at": "2026-01-31T12:34:56Z",
    "created_at": "2026-01-31T12:04:56Z"
  }
}
```

#### 5.7.2 获取订单列表

```
GET /api/v1/orders
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选 |
| page | number | 否 | 页码 |
| page_size | number | 否 | 每页数量 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "o_001",
        "order_no": "202601311234567890",
        "course": {
          "id": "cr_001",
          "name": "(7-12岁) 体能+跳绳",
          "image": "https://..."
        },
        "student_count": 1,
        "pay_amount": 80.00,
        "status": "paid",
        "class_status": "enrolling",
        "created_at": "2026-01-31T12:04:56Z"
      }
    ],
    "total": 5,
    "page": 1,
    "page_size": 20
  }
}
```

#### 5.7.3 获取订单详情

```
GET /api/v1/orders/{order_id}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "o_001",
    "order_no": "202601311234567890",
    "course": {
      "id": "cr_001",
      "name": "(7-12岁) 体能+跳绳",
      "image": "https://...",
      "schedule": "周六 08:00-09:00",
      "location": "蓝水湾",
      "total_weeks": 10,
      "current_week": 1
    },
    "students": [
      {
        "id": "s_001",
        "name": "陈乐华",
        "price": 80.00,
        "discount_price": 9.90
      }
    ],
    "total_amount": 80.00,
    "discount_amount": 70.10,
    "pay_amount": 9.90,
    "status": "paid",
    "class_status": "enrolling",
    "payment": {
      "transaction_id": "wx123456789",
      "pay_time": "2026-01-31T12:10:00Z"
    },
    "created_at": "2026-01-31T12:04:56Z"
  }
}
```

#### 5.7.4 取消订单

```
POST /api/v1/orders/{order_id}/cancel
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "o_001",
    "status": "cancelled"
  }
}
```

#### 5.7.5 申请退款

```
POST /api/v1/orders/{order_id}/refund
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reason | string | 否 | 退款原因 |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "id": "o_001",
    "status": "refunding",
    "refund_status": "processing"
  }
}
```

### 5.8 支付模块接口

#### 5.8.1 获取支付参数

```
POST /api/v1/payments/prepay
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| order_id | string | 是 | 订单ID |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "appId": "wx1234567890",
    "timeStamp": "1706684096",
    "nonceStr": "abcdef123456",
    "package": "prepay_id=wx311234567890",
    "signType": "RSA",
    "paySign": "xxxxxx"
  }
}
```

#### 5.8.2 支付回调（内部接口）

```
POST /api/v1/payments/notify
```

由微信支付服务器调用，处理支付结果通知。

### 5.9 会员模块接口

#### 5.9.1 获取权益卡列表

```
GET /api/v1/members/cards
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "id": "mc_001",
        "name": "权益卡（季卡）",
        "duration": 90,
        "original_price": 99.00,
        "price": 69.00,
        "is_recommended": true,
        "benefits": [
          "课程会员专享价",
          "每节课节省40.2元",
          "优先报名权"
        ]
      }
    ]
  }
}
```

#### 5.9.2 购买权益卡

```
POST /api/v1/members/purchase
```

**请求参数**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| card_id | string | 是 | 权益卡ID |

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "order_id": "mo_001",
    "payment_params": {
      "appId": "wx1234567890",
      "timeStamp": "1706684096",
      "nonceStr": "abcdef123456",
      "package": "prepay_id=wx311234567890",
      "signType": "RSA",
      "paySign": "xxxxxx"
    }
  }
}
```

#### 5.9.3 查询会员状态

```
GET /api/v1/members/status
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "is_member": true,
    "card": {
      "id": "mc_001",
      "name": "权益卡（季卡）"
    },
    "expire_at": "2026-04-30T23:59:59Z",
    "remaining_days": 89
  }
}
```

---

## 6. 业务流程设计

### 6.1 用户登录流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户登录流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌─────────┐                    ┌─────────┐                    ┌─────────┐
     │  用户   │                    │  小程序  │                    │  后端   │
     └────┬────┘                    └────┬────┘                    └────┬────┘
          │                              │                              │
          │  1. 点击登录                  │                              │
          │─────────────────────────────>│                              │
          │                              │                              │
          │  2. 调用 wx.login()          │                              │
          │<─────────────────────────────│                              │
          │                              │                              │
          │  3. 返回 code                │                              │
          │─────────────────────────────>│                              │
          │                              │                              │
          │                              │  4. POST /auth/wechat-login  │
          │                              │─────────────────────────────>│
          │                              │                              │
          │                              │     5. 调用微信 code2session │
          │                              │                              │
          │                              │     6. 生成/获取用户         │
          │                              │                              │
          │                              │     7. 生成 JWT Token        │
          │                              │                              │
          │                              │  8. 返回 token + 用户信息    │
          │                              │<─────────────────────────────│
          │                              │                              │
          │  9. 存储 token               │                              │
          │<─────────────────────────────│                              │
          │                              │                              │
          │  10. 判断是否需要绑定手机     │                              │
          │<─────────────────────────────│                              │
          │                              │                              │
          │  11. 点击获取手机号           │                              │
          │─────────────────────────────>│                              │
          │                              │                              │
          │  12. 调用 getPhoneNumber     │                              │
          │<─────────────────────────────│                              │
          │                              │                              │
          │  13. 返回手机号 code         │                              │
          │─────────────────────────────>│                              │
          │                              │                              │
          │                              │  14. POST /auth/bindphone    │
          │                              │─────────────────────────────>│
          │                              │                              │
          │                              │     15. 解密手机号           │
          │                              │                              │
          │                              │     16. 绑定到用户           │
          │                              │                              │
          │                              │  17. 返回绑定结果            │
          │                              │<─────────────────────────────│
          │                              │                              │
          │  18. 登录完成                 │                              │
          │<─────────────────────────────│                              │
          │                              │                              │
```

### 6.2 课程报名流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              课程报名流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐
     │  用户   │         │  小程序  │         │  后端   │         │ 微信支付 │
     └────┬────┘         └────┬────┘         └────┬────┘         └────┬────┘
          │                   │                   │                   │
          │  1. 浏览课程       │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │                   │  2. GET /courses  │                   │
          │                   │──────────────────>│                   │
          │                   │                   │                   │
          │                   │  3. 返回课程列表   │                   │
          │                   │<──────────────────│                   │
          │                   │                   │                   │
          │  4. 查看课程详情   │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │                   │  5. GET /courses/{id}                 │
          │                   │──────────────────>│                   │
          │                   │                   │                   │
          │                   │  6. 返回课程详情   │                   │
          │                   │<──────────────────│                   │
          │                   │                   │                   │
          │  7. 点击加入拼班   │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │  8. 检查登录状态   │                   │                   │
          │<──────────────────│                   │                   │
          │                   │                   │                   │
          │  9. 选择学员       │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │  10. 确认订单信息  │                   │                   │
          │<──────────────────│                   │                   │
          │                   │                   │                   │
          │  11. 同意协议      │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │  12. 点击确认支付  │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │                   │  13. POST /orders │                   │
          │                   │──────────────────>│                   │
          │                   │                   │                   │
          │                   │     14. 验证课程状态                   │
          │                   │     15. 验证学员信息                   │
          │                   │     16. 计算价格                       │
          │                   │     17. 创建订单                       │
          │                   │                   │                   │
          │                   │  18. 返回订单信息  │                   │
          │                   │<──────────────────│                   │
          │                   │                   │                   │
          │                   │  19. POST /payments/prepay            │
          │                   │──────────────────>│                   │
          │                   │                   │                   │
          │                   │                   │  20. 统一下单     │
          │                   │                   │──────────────────>│
          │                   │                   │                   │
          │                   │                   │  21. 返回预支付ID │
          │                   │                   │<──────────────────│
          │                   │                   │                   │
          │                   │  22. 返回支付参数  │                   │
          │                   │<──────────────────│                   │
          │                   │                   │                   │
          │  23. 调用支付      │                   │                   │
          │<──────────────────│                   │                   │
          │                   │                   │                   │
          │  24. 支付完成      │                   │                   │
          │──────────────────>│                   │                   │
          │                   │                   │                   │
          │                   │                   │  25. 支付回调     │
          │                   │                   │<──────────────────│
          │                   │                   │                   │
          │                   │     26. 更新订单状态                   │
          │                   │     27. 更新课程报名数                 │
          │                   │                   │                   │
          │                   │                   │  28. 返回成功     │
          │                   │                   │──────────────────>│
          │                   │                   │                   │
          │  29. 显示支付成功  │                   │                   │
          │<──────────────────│                   │                   │
          │                   │                   │                   │
```

### 6.3 订单状态流转图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              订单状态流转图                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   创建订单   │
                              └──────┬──────┘
                                     │
                                     ▼
                              ┌─────────────┐
                              │   待支付    │
                              │  (pending)  │
                              └──────┬──────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
              ▼                      ▼                      ▼
       ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
       │  支付超时    │        │   支付成功   │        │   用户取消   │
       │  自动取消    │        │             │        │             │
       └──────┬──────┘        └──────┬──────┘        └──────┬──────┘
              │                      │                      │
              ▼                      ▼                      ▼
       ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
       │   已取消    │        │   已支付    │        │   已取消    │
       │ (cancelled) │        │   (paid)    │        │ (cancelled) │
       └─────────────┘        └──────┬──────┘        └─────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
              ▼                      ▼                      ▼
       ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
       │   申请退款   │        │   等待开班   │        │   开班失败   │
       │ (refunding) │        │  (waiting)  │        │  自动退款   │
       └──────┬──────┘        └──────┬──────┘        └──────┬──────┘
              │                      │                      │
              ▼                      ▼                      ▼
       ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
       │   已退款    │        │   已开班    │        │   已退款    │
       │  (refunded) │        │  (started)  │        │  (refunded) │
       └─────────────┘        └──────┬──────┘        └─────────────┘
                                     │
                                     ▼
                              ┌─────────────┐
                              │   已完成    │
                              │ (completed) │
                              └─────────────┘
```

### 6.4 拼班状态流转图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              拼班状态流转图                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │   发布课程   │
                              └──────┬──────┘
                                     │
                                     ▼
                              ┌─────────────┐
                              │   拼班中    │◄──────────────────────┐
                              │ (enrolling) │                      │
                              └──────┬──────┘                      │
                                     │                             │
              ┌──────────────────────┼──────────────────────┐      │
              │                      │                      │      │
              ▼                      ▼                      ▼      │
       ┌─────────────┐        ┌─────────────┐        ┌─────────────┴┐
       │   报名截止   │        │  达到最低   │        │   有人退出    │
       │  人数不足    │        │  开班人数   │        │   人数不足    │
       └──────┬──────┘        └──────┬──────┘        └──────────────┘
              │                      │
              ▼                      ▼
       ┌─────────────┐        ┌─────────────┐
       │   拼班失败   │        │   待开课    │
       │  (failed)   │        │  (pending)  │
       └──────┬──────┘        └──────┬──────┘
              │                      │
              │                      ▼
              │               ┌─────────────┐
              │               │   开班中    │
              │               │  (started)  │
              │               └──────┬──────┘
              │                      │
              │                      ▼
              │               ┌─────────────┐
              │               │   已结束    │
              │               │  (ended)    │
              ▼               └─────────────┘
       ┌─────────────┐
       │   自动退款   │
       │   解散班级   │
       └─────────────┘
```

---

## 7. 数据库设计

### 7.1 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  ER 图                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
│     users       │          │    students     │          │   communities   │
├─────────────────┤          ├─────────────────┤          ├─────────────────┤
│ PK id           │──┐       │ PK id           │          │ PK id           │
│    openid       │  │  ┌───>│ FK user_id      │          │    name         │
│    unionid      │  │  │    │    id_type      │          │    address      │
│    phone        │  │  │    │    id_name      │          │    image        │
│    nickname     │  │  │    │    id_number    │          │    latitude     │
│    avatar       │  │  │    │    photo        │          │    longitude    │
│    health_beans │  └──┘    │    birthday     │          │    status       │
│    is_member    │          │    gender       │          │    created_at   │
│    member_expire│          │    member_type  │          │    updated_at   │
│    created_at   │          │    created_at   │          └────────┬────────┘
│    updated_at   │          │    updated_at   │                   │
└────────┬────────┘          └─────────────────┘                   │
         │                                                         │
         │                                                         │
         │  ┌─────────────────────────────────────────────────────┘
         │  │
         │  │     ┌─────────────────┐          ┌─────────────────┐
         │  │     │    teachers     │          │    courses      │
         │  │     ├─────────────────┤          ├─────────────────┤
         │  │     │ PK id           │──┐       │ PK id           │
         │  │     │    name         │  │  ┌───>│ FK teacher_id   │
         │  │     │    avatar       │  │  │    │ FK community_id │<────┐
         │  │     │    phone        │  │  │    │    name         │     │
         │  │     │    intro        │  └──┘    │    image        │     │
         │  │     │    created_at   │          │    age_range    │     │
         │  │     │    updated_at   │          │    total_weeks  │     │
         │  │     └─────────────────┘          │    total_lessons│     │
         │  │                                  │    schedule     │     │
         │  │                                  │    price        │     │
         │  │                                  │    member_price │     │
         │  │                                  │    min_students │     │
         │  │                                  │    max_students │     │
         │  │                                  │    deadline     │     │
         │  │                                  │    status       │     │
         │  │                                  │    created_at   │     │
         │  │                                  │    updated_at   │     │
         │  │                                  └────────┬────────┘     │
         │  │                                           │              │
         │  └───────────────────────────────────────────┼──────────────┘
         │                                              │
         │                                              │
         │  ┌─────────────────┐          ┌─────────────┴───┐
         │  │     orders      │          │ course_students │
         │  ├─────────────────┤          ├─────────────────┤
         └─>│ PK id           │          │ PK id           │
            │ FK user_id      │          │ FK course_id    │<─────┐
            │ FK course_id    │──────────│ FK student_id   │      │
            │    order_no     │          │ FK order_id     │──────┤
            │    total_amount │          │    price        │      │
            │    discount_amt │          │    status       │      │
            │    pay_amount   │          │    created_at   │      │
            │    status       │          └─────────────────┘      │
            │    pay_time     │                                   │
            │    expire_at    │          ┌─────────────────┐      │
            │    created_at   │          │    payments     │      │
            │    updated_at   │          ├─────────────────┤      │
            └────────┬────────┘          │ PK id           │      │
                     │                   │ FK order_id     │──────┘
                     │                   │    transaction_id│
                     └──────────────────>│    amount       │
                                         │    status       │
                                         │    pay_time     │
                                         │    refund_time  │
                                         │    created_at   │
                                         └─────────────────┘


┌─────────────────┐          ┌─────────────────┐          ┌─────────────────┐
│  member_cards   │          │ user_members    │          │    banners      │
├─────────────────┤          ├─────────────────┤          ├─────────────────┤
│ PK id           │──┐       │ PK id           │          │ PK id           │
│    name         │  │  ┌───>│ FK user_id      │          │    title        │
│    duration     │  │  │    │ FK card_id      │<─────────│    image        │
│    price        │  │  │    │    start_at     │          │    link         │
│    original_price│  └─┘    │    expire_at    │          │    sort_order   │
│    benefits     │          │    status       │          │    status       │
│    is_recommended│          │    created_at   │          │    created_at   │
│    status       │          └─────────────────┘          │    updated_at   │
│    created_at   │                                       └─────────────────┘
│    updated_at   │
└─────────────────┘
```

### 7.2 数据表设计

#### 7.2.1 用户表 (users)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 用户ID |
| openid | VARCHAR(64) | UNIQUE, NOT NULL | 微信OpenID |
| unionid | VARCHAR(64) | UNIQUE | 微信UnionID |
| phone | VARCHAR(20) | UNIQUE | 手机号 |
| nickname | VARCHAR(64) | | 昵称 |
| avatar | VARCHAR(512) | | 头像URL |
| health_beans | INT | DEFAULT 0 | 健康豆 |
| is_member | TINYINT(1) | DEFAULT 0 | 是否会员 |
| member_expire_at | DATETIME | | 会员过期时间 |
| status | TINYINT(1) | DEFAULT 1 | 状态 1正常 0禁用 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_openid` (openid)
- `idx_phone` (phone)
- `idx_unionid` (unionid)

#### 7.2.2 学员表 (students)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 学员ID |
| user_id | VARCHAR(32) | FK, NOT NULL | 用户ID |
| id_type | VARCHAR(20) | NOT NULL | 证件类型 |
| id_name | VARCHAR(64) | NOT NULL | 证件姓名 |
| id_number | VARCHAR(64) | NOT NULL | 证件号码(加密) |
| id_number_hash | VARCHAR(64) | NOT NULL | 证件号码哈希 |
| photo | VARCHAR(512) | | 照片URL |
| birthday | DATE | NOT NULL | 出生日期 |
| gender | VARCHAR(10) | NOT NULL | 性别 |
| member_type | VARCHAR(20) | DEFAULT 'normal' | 会员类型 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_user_id` (user_id)
- `idx_id_number_hash` (id_number_hash)

#### 7.2.3 小区表 (communities)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 小区ID |
| name | VARCHAR(128) | NOT NULL | 小区名称 |
| address | VARCHAR(256) | NOT NULL | 详细地址 |
| image | VARCHAR(512) | | 小区图片 |
| latitude | DECIMAL(10,7) | NOT NULL | 纬度 |
| longitude | DECIMAL(10,7) | NOT NULL | 经度 |
| province | VARCHAR(32) | | 省份 |
| city | VARCHAR(32) | | 城市 |
| district | VARCHAR(32) | | 区县 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_location` (latitude, longitude)
- `idx_city` (city)
- `idx_name` (name)

#### 7.2.4 教练表 (teachers)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 教练ID |
| name | VARCHAR(64) | NOT NULL | 姓名 |
| avatar | VARCHAR(512) | | 头像 |
| phone | VARCHAR(20) | | 手机号 |
| intro | TEXT | | 简介 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 7.2.5 课程表 (courses)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 课程ID |
| community_id | VARCHAR(32) | FK, NOT NULL | 小区ID |
| teacher_id | VARCHAR(32) | FK, NOT NULL | 教练ID |
| name | VARCHAR(128) | NOT NULL | 课程名称 |
| image | VARCHAR(512) | | 课程图片 |
| age_min | INT | NOT NULL | 最小年龄 |
| age_max | INT | NOT NULL | 最大年龄 |
| total_weeks | INT | NOT NULL | 总周数 |
| total_lessons | INT | NOT NULL | 总课时 |
| schedule_day | VARCHAR(20) | NOT NULL | 上课日 |
| schedule_start | TIME | NOT NULL | 开始时间 |
| schedule_end | TIME | NOT NULL | 结束时间 |
| location | VARCHAR(256) | | 上课地点详情 |
| price | DECIMAL(10,2) | NOT NULL | 原价 |
| member_price | DECIMAL(10,2) | NOT NULL | 会员价 |
| min_students | INT | NOT NULL | 最低开班人数 |
| max_students | INT | NOT NULL | 最大人数 |
| enrolled_count | INT | DEFAULT 0 | 已报名人数 |
| deadline | DATETIME | NOT NULL | 报名截止时间 |
| start_date | DATE | | 开课日期 |
| status | VARCHAR(20) | DEFAULT 'enrolling' | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_community_id` (community_id)
- `idx_status` (status)
- `idx_deadline` (deadline)

**状态枚举**:
- `enrolling`: 拼班中
- `pending`: 待开课
- `started`: 开班中
- `ended`: 已结束
- `failed`: 拼班失败
- `cancelled`: 已取消

#### 7.2.6 订单表 (orders)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 订单ID |
| order_no | VARCHAR(32) | UNIQUE, NOT NULL | 订单号 |
| user_id | VARCHAR(32) | FK, NOT NULL | 用户ID |
| course_id | VARCHAR(32) | FK, NOT NULL | 课程ID |
| total_amount | DECIMAL(10,2) | NOT NULL | 订单总额 |
| discount_amount | DECIMAL(10,2) | DEFAULT 0 | 优惠金额 |
| pay_amount | DECIMAL(10,2) | NOT NULL | 实付金额 |
| coupon_id | VARCHAR(32) | | 优惠券ID |
| status | VARCHAR(20) | NOT NULL | 订单状态 |
| pay_time | DATETIME | | 支付时间 |
| expire_at | DATETIME | NOT NULL | 过期时间 |
| refund_time | DATETIME | | 退款时间 |
| refund_amount | DECIMAL(10,2) | | 退款金额 |
| remark | VARCHAR(256) | | 备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_order_no` (order_no)
- `idx_user_id` (user_id)
- `idx_course_id` (course_id)
- `idx_status` (status)
- `idx_created_at` (created_at)

**状态枚举**:
- `pending`: 待支付
- `paid`: 已支付
- `cancelled`: 已取消
- `refunding`: 退款中
- `refunded`: 已退款
- `completed`: 已完成

#### 7.2.7 课程学员关联表 (course_students)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | ID |
| course_id | VARCHAR(32) | FK, NOT NULL | 课程ID |
| student_id | VARCHAR(32) | FK, NOT NULL | 学员ID |
| order_id | VARCHAR(32) | FK, NOT NULL | 订单ID |
| price | DECIMAL(10,2) | NOT NULL | 单价 |
| is_new_user | TINYINT(1) | DEFAULT 0 | 是否新人价 |
| status | VARCHAR(20) | NOT NULL | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**:
- `idx_course_id` (course_id)
- `idx_student_id` (student_id)
- `idx_order_id` (order_id)
- `uk_course_student` (course_id, student_id) UNIQUE

#### 7.2.8 支付记录表 (payments)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 支付ID |
| order_id | VARCHAR(32) | FK, NOT NULL | 订单ID |
| transaction_id | VARCHAR(64) | | 微信支付交易号 |
| amount | DECIMAL(10,2) | NOT NULL | 支付金额 |
| status | VARCHAR(20) | NOT NULL | 状态 |
| pay_time | DATETIME | | 支付时间 |
| refund_id | VARCHAR(64) | | 退款单号 |
| refund_amount | DECIMAL(10,2) | | 退款金额 |
| refund_time | DATETIME | | 退款时间 |
| raw_data | JSON | | 原始数据 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**:
- `idx_order_id` (order_id)
- `idx_transaction_id` (transaction_id)

#### 7.2.9 权益卡表 (member_cards)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | 卡ID |
| name | VARCHAR(64) | NOT NULL | 卡名称 |
| duration | INT | NOT NULL | 有效天数 |
| price | DECIMAL(10,2) | NOT NULL | 售价 |
| original_price | DECIMAL(10,2) | NOT NULL | 原价 |
| benefits | JSON | | 权益列表 |
| is_recommended | TINYINT(1) | DEFAULT 0 | 是否推荐 |
| sort_order | INT | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

#### 7.2.10 用户会员记录表 (user_members)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | ID |
| user_id | VARCHAR(32) | FK, NOT NULL | 用户ID |
| card_id | VARCHAR(32) | FK, NOT NULL | 权益卡ID |
| order_id | VARCHAR(32) | | 购买订单ID |
| start_at | DATETIME | NOT NULL | 开始时间 |
| expire_at | DATETIME | NOT NULL | 过期时间 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**:
- `idx_user_id` (user_id)
- `idx_expire_at` (expire_at)

#### 7.2.11 轮播图表 (banners)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | VARCHAR(32) | PK | ID |
| title | VARCHAR(128) | | 标题 |
| image | VARCHAR(512) | NOT NULL | 图片URL |
| link | VARCHAR(512) | | 跳转链接 |
| link_type | VARCHAR(20) | | 链接类型 |
| sort_order | INT | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

### 7.3 索引设计原则

1. **主键索引**: 所有表使用 VARCHAR(32) 类型的 UUID 作为主键
2. **外键索引**: 所有外键字段创建索引
3. **查询索引**: 根据业务查询需求创建组合索引
4. **唯一索引**: 业务唯一字段创建唯一索引

### 7.4 数据安全设计

1. **敏感数据加密**:
   - 身份证号码使用 AES-256 加密存储
   - 同时存储哈希值用于查询

2. **数据脱敏**:
   - API 返回时对敏感字段脱敏
   - 手机号: `136****8295`
   - 身份证: `4401**********1234`

3. **数据备份**:
   - 每日全量备份
   - 实时 binlog 备份
   - 跨区域备份

---

## 8. 安全设计

### 8.1 认证授权

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              JWT Token 结构                                  │
└─────────────────────────────────────────────────────────────────────────────┘

Header:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payload:
{
  "sub": "u_123456",          // 用户ID
  "iat": 1706684096,          // 签发时间
  "exp": 1706691296,          // 过期时间
  "type": "access"            // Token 类型
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret
)
```

### 8.2 接口安全

| 安全措施 | 说明 |
|----------|------|
| HTTPS | 所有接口强制 HTTPS |
| 签名验证 | 微信支付回调签名验证 |
| 请求频率限制 | 同一用户 100 次/分钟 |
| 请求参数校验 | Pydantic Schema 验证 |
| SQL 注入防护 | ORM 参数化查询 |
| XSS 防护 | 输入输出转义 |

### 8.3 数据安全

| 数据类型 | 保护措施 |
|----------|----------|
| 密码 | bcrypt 哈希 |
| 身份证号 | AES-256 加密 |
| 手机号 | 显示时脱敏 |
| 支付信息 | 不存储，调用微信支付 |
| 日志 | 敏感信息脱敏 |

---

## 9. 本地开发环境

### 9.1 环境要求

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| Python | 3.12+ | 后端运行环境 |
| Node.js | 18+ | 前端构建工具 |
| MySQL | 8.0+ | 数据库 |
| 微信开发者工具 | 最新版 | 小程序调试 |

### 9.2 目录结构

```
spot/
├── backend/                  # 后端项目
│   ├── src/
│   ├── uploads/              # 文件上传目录
│   ├── logs/                 # 日志目录
│   ├── pyproject.toml
│   └── .env                  # 环境变量
│
├── miniprogram/              # 小程序项目
│   ├── pages/
│   ├── components/
│   └── project.config.json
│
├── admin-web/                # 管理后台
│   ├── src/
│   └── package.json
│
└── specs/                    # 文档目录
    ├── 0001-prd.md
    └── 0002-design.md
```

### 9.3 本地开发配置

#### 后端环境变量 (.env)

```bash
# 应用配置
APP_NAME=spot
APP_ENV=development
DEBUG=true
SECRET_KEY=your-secret-key-for-development

# 数据库配置
DATABASE_URL=mysql+asyncmy://root:password@localhost:3306/spot

# 文件上传配置
UPLOAD_DIR=./uploads
MAX_UPLOAD_SIZE=10485760  # 10MB

# 微信小程序配置
WECHAT_APP_ID=your-app-id
WECHAT_APP_SECRET=your-app-secret

# 微信支付配置 (开发环境可选)
WECHAT_MCH_ID=your-mch-id
WECHAT_API_KEY=your-api-key

# 日志配置
LOG_LEVEL=DEBUG
LOG_DIR=./logs
```

#### 数据库初始化

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS spot
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

-- 使用数据库
USE spot;

-- 初始化管理员账号（密码为 admin123 的 bcrypt 哈希）
INSERT INTO admins (id, username, password_hash, name, status, created_at, updated_at)
VALUES (
  'admin_001',
  'admin',
  '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.VTtYr6D1HwXHHm',
  '系统管理员',
  1,
  NOW(),
  NOW()
);
```

### 9.4 启动命令

```bash
# 后端启动
cd backend
uv sync                        # 安装依赖
uv run alembic upgrade head    # 数据库迁移
uv run uvicorn src.main:app --reload --host 0.0.0.0 --port 8000

# 管理后台启动
cd admin-web
npm install                    # 安装依赖
npm run dev                    # 启动开发服务器 (默认 http://localhost:5173)

# 小程序调试
# 使用微信开发者工具打开 miniprogram 目录
```

### 9.5 文件存储说明

本地开发环境使用本地文件系统存储上传的文件：

| 目录 | 用途 |
|------|------|
| `uploads/images/` | 图片文件（课程图、小区图、头像等） |
| `uploads/temp/` | 临时文件 |
| `logs/` | 应用日志文件 |

**文件访问 URL 格式**：
- 本地开发：`http://localhost:8000/uploads/images/{filename}`
- 通过 FastAPI 静态文件服务提供访问

---

## 附录

### A. 状态枚举定义

#### 订单状态 (OrderStatus)
| 值 | 说明 |
|---|------|
| pending | 待支付 |
| paid | 已支付 |
| cancelled | 已取消 |
| refunding | 退款中 |
| refunded | 已退款 |
| completed | 已完成 |

#### 课程状态 (CourseStatus)
| 值 | 说明 |
|---|------|
| enrolling | 拼班中 |
| pending | 待开课 |
| started | 开班中 |
| ended | 已结束 |
| failed | 拼班失败 |
| cancelled | 已取消 |

#### 支付状态 (PaymentStatus)
| 值 | 说明 |
|---|------|
| pending | 待支付 |
| success | 支付成功 |
| failed | 支付失败 |
| refunded | 已退款 |

### B. 地图方案说明

本项目采用**方案A：最小化使用**，无需购买腾讯地图商业授权（5万元/年）。

#### 实现方式

| 功能 | 实现方案 | 说明 |
|------|----------|------|
| 地图展示 | 小程序内置 `<map>` 组件 | 免费，无需配置 |
| 用户定位 | `wx.getLocation` API | 免费，需用户授权 |
| 小区数据 | 后台管理员配置 | 包含名称、地址、经纬度 |
| 距离计算 | 后端 Haversine 公式 | 纯算法，无外部依赖 |
| 小区搜索 | 后端关键词匹配 | 数据库 LIKE 查询 |

#### 前端实现

```javascript
// 1. 地图展示 - 使用内置组件
<map
  longitude="{{longitude}}"
  latitude="{{latitude}}"
  markers="{{markers}}"
  scale="16"
/>

// 2. 获取用户位置 - 使用内置 API
wx.getLocation({
  type: 'gcj02',  // 国测局坐标
  success(res) {
    const { latitude, longitude } = res
    // 传给后端计算距离
  }
})

// 3. 选择位置 - 使用内置 API
wx.chooseLocation({
  success(res) {
    // 返回选中的位置信息
  }
})
```

#### 后端实现

```python
# geo.py - Haversine 公式计算两点间距离
import math

def haversine_distance(
    lat1: float, lon1: float,
    lat2: float, lon2: float
) -> float:
    """
    计算两个经纬度坐标之间的距离（米）
    使用 Haversine 公式
    """
    R = 6371000  # 地球半径（米）

    phi1 = math.radians(lat1)
    phi2 = math.radians(lat2)
    delta_phi = math.radians(lat2 - lat1)
    delta_lambda = math.radians(lon2 - lon1)

    a = (math.sin(delta_phi / 2) ** 2 +
         math.cos(phi1) * math.cos(phi2) *
         math.sin(delta_lambda / 2) ** 2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))

    return R * c  # 返回距离（米）
```

#### 数据流程

```
用户打开小程序
      │
      ▼
wx.getLocation 获取用户坐标 (lat, lon)
      │
      ▼
请求后端 GET /api/v1/communities?latitude=xx&longitude=xx
      │
      ▼
后端查询小区列表，使用 Haversine 计算每个小区到用户的距离
      │
      ▼
按距离排序后返回小区列表
      │
      ▼
前端使用 <map> 组件展示小区位置
```

#### 优势

- **零成本**：无需购买商业授权
- **无风险**：不依赖第三方服务配额限制
- **性能好**：距离计算在后端完成，响应快
- **可控性强**：小区数据由管理员维护，准确可靠

### C. 参考文档

- PRD 文档: `specs/0001-prd.md`
- UI 设计稿: `specs/ui/` 目录
- 微信小程序开发文档: https://developers.weixin.qq.com/miniprogram/dev/framework/
- 微信支付文档: https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml
- FastAPI 文档: https://fastapi.tiangolo.com/
