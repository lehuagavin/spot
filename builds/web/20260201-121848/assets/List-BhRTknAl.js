import{r as a,F as r,z as s,t as e,A as d,B as de,D as c,S as ce,E as P}from"./index-DvoX4KWS.js";import{g as me,u as ue,c as ge,d as pe}from"./communities-DiEFuF_v.js";import{g as L,a as xe,b as he}from"./upload-DvrawW7b.js";import{I as ye,R as Ae}from"./ImageUpload-MMgr9A6g.js";import{E as je}from"./EmptyState-CMF6F_bM.js";import{S as x,R as I,I as U}from"./aiStyles-C31G1lXh.js";import{S as h,d as fe}from"./Pagination-C9k_HsGX.js";import{R as ve}from"./PlusOutlined-DIcF2SQF.js";import{F as be,R as m}from"./Table-ClhJkhx_.js";import{M as Se}from"./index-DQIhW2ij.js";import{T as Y}from"./index-BIxBvGOn.js";import{T as Ie}from"./index-CqbZCbjk.js";import{R as we}from"./EditOutlined-wk0OXdBO.js";import{P as ke}from"./index-Dqy8LGeE.js";import"./progress-BlanDxPG.js";import"./Skeleton-DJqBIV4h.js";function Ke(){const[q,D]=a.useState(!1),[K,O]=a.useState([]),[V,_]=a.useState(0),[n,E]=a.useState({page:1,page_size:10}),[N,y]=a.useState(!1),[u,R]=a.useState(null),[l]=r.useForm(),[H,M]=a.useState(!1),[T,w]=a.useState("upload"),[A,j]=a.useState(""),[z,J]=a.useState("2K"),[f,Q]=a.useState(!1),[g,p]=a.useState(null),[v,k]=a.useState("manual"),[o,b]=a.useState(x[0].value),[B,F]=a.useState(!1),[G,W]=a.useState({}),S=r.useWatch("name",l);a.useEffect(()=>{C()},[n]);const C=async()=>{D(!0);try{const t=await me(n);O(t.items),_(t.total)}catch{s.error("获取小区列表失败")}finally{D(!1)}},$=t=>{E({...n,page:1,keyword:t})},X=t=>{E({...n,page:t.current||1,page_size:t.pageSize||10})},Z=()=>{R(null),l.resetFields(),w("upload"),j(G.new||""),p(null),k("manual"),b(x[0].value),y(!0)},ee=t=>{R(t),l.setFieldsValue(t),w("upload"),p(null),j(G[t.id]||""),k("manual"),b(x[0].value),y(!0)},te=async t=>{try{await pe(t),s.success("删除成功"),C()}catch{s.error("删除失败")}},ae=async()=>{if(!o){s.warning("请先选择一种艺术风格");return}if(!S?.trim()){s.warning("请先填写小区名称");return}const t=l.getFieldsValue();F(!0);try{const i=await xe({style:o,context_type:"banner",context_data:{title:`${t.name}小区`+(t.address?` - ${t.address}`:"")}});j(i.description);const ne=u?.id||"new";W(oe=>({...oe,[ne]:i.description})),s.success("描述生成成功，您可以继续编辑")}catch(i){i.response?.data?.detail?.code==="API_KEY_MISSING"?s.error("系统未配置AI描述生成功能，请联系管理员"):i.response?.data?.detail?.code==="QUOTA_EXCEEDED"?s.error("AI服务配额已用完，请稍后重试或手动输入"):s.error("描述生成失败，请手动输入")}finally{F(!1)}},se=async()=>{if(!A.trim()){s.warning("请输入图片描述");return}Q(!0);try{const t=await he({prompt:A,size:z});p(t.url),l.setFieldsValue({image:t.url}),s.success("图片生成成功")}catch(t){t instanceof Error?s.error(t.message):s.error("生成图片失败")}finally{Q(!1)}},re=()=>{g&&(l.setFieldsValue({image:g}),s.success("已应用生成的图片"))},ie=async()=>{try{const t=await l.validateFields();M(!0),u?(await ue(u.id,t),s.success("更新成功")):(await ge(t),s.success("创建成功")),y(!1),p(null),C()}catch(t){t instanceof Error&&s.error(t.message)}finally{M(!1)}},le=[{title:"小区图片",dataIndex:"image",key:"image",width:100,render:t=>e.jsx(U,{src:L(t),width:60,height:60,style:{objectFit:"cover",borderRadius:"var(--radius-sm)"},fallback:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAADDCAYAAADQvc6UAAABRWlDQ1BJQ0MgUHJvZmlsZQAAKJFjYGASSSwoyGFhYGDIzSspCnJ3UoiIjFJgf8LAwSDCIMogwMCcmFxc4BgQ4ANUwgCjUcG3awyMIPqyLsis7PPOq3QdDFcvjV3jOD1boQVTPQrgSkktTgbSf4A4LbmgqISBgTEFyFYuLykAsTuAbJEioKOA7DkgdjqEvQHEToKwj4DVhAQ5A9k3gGyB5IxEoBmML4BsnSQk8XQkNtReEOBxcfXxUQg1Mjc0dyHgXNJBSWpFCYh2zi+oLMpMzyhRcASGUqqCZ16yno6CkYGRAQMDKMwhqj/fAIcloxgHQqxAjIHBEugw5sUIsSQpBobtQPdLciLEVJYzMPBHMDBsayhILEqEO4DxG0txmrERhM29nYGBddr//5/DGRjYNRkY/l7////39v///y4Dmn+LgeHANwDrkl1AuO+pmgAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAwqADAAQAAAABAAAAwwAAAAD9b/HnAAAHlklEQVR4Ae3dP3Kc"})},{title:"小区名称",dataIndex:"name",key:"name",render:t=>e.jsx("span",{style:{fontWeight:500},children:t})},{title:"地址",dataIndex:"address",key:"address",ellipsis:!0},{title:"经纬度",key:"location",render:(t,i)=>e.jsxs("span",{style:{color:"var(--color-text-secondary)"},children:[Number(i.latitude).toFixed(4),", ",Number(i.longitude).toFixed(4)]})},{title:"状态",dataIndex:"status",key:"status",render:t=>e.jsx(Ie,{color:t===1?"success":"default",children:t===1?"启用":"禁用"})},{title:"创建时间",dataIndex:"created_at",key:"created_at",render:t=>fe(t).format("YYYY-MM-DD HH:mm")},{title:"操作",key:"action",width:150,render:(t,i)=>e.jsxs(P,{children:[e.jsx(c,{type:"link",size:"small",icon:e.jsx(we,{}),onClick:()=>ee(i),children:"编辑"}),e.jsx(ke,{title:"确定要删除这个小区吗？",onConfirm:()=>te(i.id),okText:"确定",cancelText:"取消",children:e.jsx(c,{type:"link",size:"small",danger:!0,icon:e.jsx(Ae,{}),children:"删除"})})]})}];return e.jsxs("div",{className:"fade-in",children:[e.jsx("div",{style:{marginBottom:24,display:"flex",alignItems:"center",justifyContent:"space-between",backgroundImage:"linear-gradient(135deg, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.7) 100%), url(/images/community-home.png)",backgroundSize:"cover, cover",backgroundPosition:"center, center",borderRadius:"var(--radius-lg)",padding:"24px 32px"},children:e.jsxs("div",{children:[e.jsx("h1",{style:{fontSize:"var(--font-size-2xl)",fontWeight:600,color:"var(--color-text-primary)",marginBottom:4},children:"小区管理"}),e.jsx("p",{style:{color:"var(--color-text-secondary)"},children:"管理可服务的小区信息"})]})}),e.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(d.Search,{placeholder:"搜索小区名称或地址",allowClear:!0,onSearch:$,style:{width:300},prefix:e.jsx(de,{style:{color:"var(--color-text-tertiary)"}})}),e.jsx(c,{type:"primary",icon:e.jsx(ve,{}),onClick:Z,children:"新增小区"})]}),e.jsx(be,{columns:le,dataSource:K,rowKey:"id",loading:q,locale:{emptyText:e.jsx(je,{description:"暂无小区数据",imageSize:120})},pagination:{current:n.page,pageSize:n.page_size,total:V,showSizeChanger:!0,showQuickJumper:!0,showTotal:t=>`共 ${t} 条`},onChange:X}),e.jsx(Se,{title:u?"编辑小区":"新增小区",open:N,onCancel:()=>{y(!1),p(null)},onOk:ie,confirmLoading:H,width:800,destroyOnClose:!0,children:e.jsxs(r,{form:l,layout:"vertical",style:{marginTop:24},children:[e.jsx(r.Item,{name:"name",label:"小区名称",rules:[{required:!0,message:"请输入小区名称"}],children:e.jsx(d,{placeholder:"请输入小区名称"})}),e.jsx(r.Item,{name:"address",label:"详细地址",rules:[{required:!0,message:"请输入详细地址"}],children:e.jsx(d.TextArea,{placeholder:"请输入详细地址",rows:2})}),e.jsx(r.Item,{label:"图片来源",children:e.jsxs(m.Group,{value:T,onChange:t=>w(t.target.value),style:{marginBottom:16},children:[e.jsx(m.Button,{value:"upload",children:"上传图片"}),e.jsxs(m.Button,{value:"ai",children:[e.jsx(I,{})," AI 生成"]})]})}),T==="upload"?e.jsx(r.Item,{name:"image",label:"小区图片",children:e.jsx(ye,{})}):e.jsxs("div",{style:{background:"var(--color-bg-secondary)",padding:16,borderRadius:"var(--radius-md)",marginBottom:24},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:16},children:[e.jsx(r.Item,{label:"描述生成方式",style:{marginBottom:0},children:e.jsxs(m.Group,{value:v,onChange:t=>{k(t.target.value),t.target.value==="auto"&&!o&&b(x[0].value)},children:[e.jsx(m.Button,{value:"manual",children:"手动输入"}),e.jsxs(m.Button,{value:"auto",children:[e.jsx(I,{})," 智能生成"]})]})}),v==="auto"&&e.jsx(r.Item,{label:"艺术风格",style:{marginBottom:0},children:e.jsx(h,{value:o,onChange:b,placeholder:"请选择艺术风格",style:{width:"100%"},optionLabelProp:"label",children:x.map(t=>e.jsx(h.Option,{value:t.value,label:t.label,children:e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:500},children:t.label}),e.jsx("div",{style:{fontSize:12,color:"var(--color-text-secondary)"},children:t.description})]})},t.value))})})]}),v==="auto"&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:16},children:[e.jsx(c,{type:"primary",icon:e.jsx(I,{}),onClick:ae,loading:B,disabled:!o||!S?.trim(),children:B?"生成中...":"生成描述"}),!S?.trim()&&e.jsx("span",{style:{fontSize:12,color:"#faad14"},children:"请先填写小区名称"}),S?.trim()&&!o&&e.jsx("span",{style:{fontSize:12,color:"#faad14"},children:"请选择艺术风格"})]}),e.jsx(r.Item,{label:"图片描述",required:!0,help:"描述小区场景、建筑风格、环境等特点，会影响生成的图片效果",children:e.jsx(d.TextArea,{value:A,onChange:t=>j(t.target.value),placeholder:"请输入图片描述，例如：现代化高层住宅小区，绿树成荫，配套设施完善",rows:4,disabled:v==="auto"&&B})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr",gap:16,marginBottom:16},children:[e.jsx(r.Item,{label:"图片尺寸",style:{marginBottom:0},children:e.jsxs(h,{value:z,onChange:J,children:[e.jsx(h.Option,{value:"1K",children:"1024x1024 (1K)"}),e.jsx(h.Option,{value:"2K",children:"2048x2048 (2K)"})]})}),e.jsx("div",{style:{display:"flex",alignItems:"flex-end"},children:e.jsx(c,{type:"primary",icon:e.jsx(I,{}),onClick:se,loading:f,disabled:!A.trim(),block:!0,children:f?"生成中...":"生成图片"})})]}),(g||f)&&e.jsxs("div",{style:{marginTop:16,padding:16,background:"var(--color-bg-primary)",borderRadius:"var(--radius-md)",border:"1px solid var(--color-border)"},children:[e.jsx("div",{style:{marginBottom:8,fontWeight:500,color:"var(--color-text-primary)"},children:"生成结果"}),f?e.jsx("div",{style:{height:160,display:"flex",alignItems:"center",justifyContent:"center",background:"var(--color-bg-secondary)",borderRadius:"var(--radius-sm)"},children:e.jsx(ce,{tip:"AI 正在生成图片，请稍候..."})}):g?e.jsxs("div",{children:[e.jsx(U,{src:L(g),width:200,style:{borderRadius:"var(--radius-sm)",marginBottom:12}}),e.jsx("div",{children:e.jsx(c,{type:"primary",size:"small",onClick:re,children:"使用此图片"})})]}):null]}),e.jsx(r.Item,{name:"image",style:{display:"none"},children:e.jsx(d,{})})]}),e.jsxs(P,{size:16,children:[e.jsx(r.Item,{name:"latitude",label:"纬度",rules:[{required:!0,message:"请输入纬度"}],children:e.jsx(Y,{placeholder:"如: 20.0",style:{width:200},min:-90,max:90,precision:6})}),e.jsx(r.Item,{name:"longitude",label:"经度",rules:[{required:!0,message:"请输入经度"}],children:e.jsx(Y,{placeholder:"如: 110.0",style:{width:200},min:-180,max:180,precision:6})})]}),u&&e.jsx(r.Item,{name:"status",label:"状态",initialValue:1,children:e.jsx(d,{type:"hidden"})})]})})]})}export{Ke as default};
